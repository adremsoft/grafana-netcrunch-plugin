{"version":3,"sources":["../../src/datasource/datasource.js"],"names":["CONNECTION_ERROR_MESSAGES","MAX_SAMPLE_COUNT","NetCrunchMetricFindQuery","PRIVATE_PROPERTIES","netCrunchAPI","Symbol","netCrunchConnection","atlas","nodes","processedNodes","alertSrv","templateSrv","SERIES_TYPES_DISPLAY_NAMES","min","avg","max","avail","delta","equal","distr","NET_CRUNCH_DATASOURCE_DI","NetCrunchDatasource","instanceSettings","netCrunchAPIService","$rootScope","initNodesUpdating","networkAtlas","fromCache","updateNodes","then","nodesReady","nodesBuffer","operations","asyncSortByNameAndAddress","getAllNodes","sorted","all","processedNodesReady","$on","self","name","initAtlasUpdating","initAtlas","atlasReady","initDatasource","Promise","resolve","reject","netCrunchSession","url","getConnection","connection","catch","error","set","console","log","datasourceInitialization","serverUrl","jsonData","simpleUrl","username","user","password","datasourceReady","testConnection","status","message","title","options","validateCounterData","nodeId","counterName","countersAPI","counters","nodeName","getNodeById","nodeData","counterDisplayName","getCounters","counterList","counterData","findCounterByName","displayName","seriesTypesSelected","series","Object","keys","some","seriesKey","prepareSeriesName","datasource","alias","seriesName","extendSeriesName","baseSeriesName","seriesType","prepareSeriesDataQuery","range","trendsAPI","trends","getCounterTrendData","from","to","periodType","periodInterval","dataPoints","values","map","domain","prepareTargetQuery","target","decodedNodeId","decodeNodeIdTemplate","nodeID","targetDataQuery","hide","counterDataComplete","query","seriesDataQuery","seriesTypes","create","validateSeriesTypes","push","prepareQueries","targets","rawData","result","forEach","prepareChartData","targetsChartData","counterSeries","data","length","targetSeries","datapoints","grafanaDataConverter","performQuery","queryOptions","globalOptions","scopedVars","setMaxDataPoints","maxDataPoints","rangeFrom","startOf","rangeTo","dataQueries","prepareTimeRange","concat","ERROR_MESSAGE","periodName","process","variables","filter","decodeDatasourceNameTemplate","variable","match","Number","isInteger","getNodeVariables","findIndex","datasourceName","replace","isNodeTemplate","templateValue","idValue","split","getCountersForMonitors","buffer","type","$inject"],"mappings":"8fAQSA,yB,6BAAAA,yB,CAA2BC,gB,6BAAAA,gB,0CAC3BC,wB,+BAAAA,wB,kgBAGPC,kB,CAAqB,CACnBC,aAAcC,OAAO,cAAP,CADK,CAEnBC,oBAAqBD,OAAO,qBAAP,CAFF,CAGnBE,MAAOF,OAAO,OAAP,CAHY,CAInBG,MAAOH,OAAO,OAAP,CAJY,CAKnBI,eAAgBJ,OAAO,gBAAP,CALG,CAMnBK,SAAUL,OAAO,UAAP,CANS,CAOnBM,YAAaN,OAAO,aAAP,CAPM,C,CASrBO,0B,CAA6B,CAC3BC,IAAK,KADsB,CAE3BC,IAAK,KAFsB,CAG3BC,IAAK,KAHsB,CAI3BC,MAAO,OAJoB,CAK3BC,MAAO,OALoB,CAM3BC,MAAO,OANoB,CAO3BC,MAAO,OAPoB,C,CAS7BC,wB,gHAEIC,mB,YAEJ,6BAAYC,CAAZ,CAA8BC,CAA9B,CAAmDb,CAAnD,CAA6DC,CAA7D,CAA0Ea,CAA1E,CAAsF,CAUpF,QAASC,EAAT,CAA2BC,CAA3B,CAAyCC,CAAzC,CAAoD,CAElD,QAASC,EAAT,EAAuB,CACrBF,EAAanB,KAAb,GAAqBsB,IAArB,CAA0B,SAACtB,CAAD,CAAW,CACnCuB,EAAWvB,EAAMC,KAAjB,CADmC,CAEnCuB,EAAYC,UAAZ,CAAyBzB,EAAMC,KAAN,CAAYwB,UAFF,CAGnCD,EAAYC,UAAZ,CACGC,yBADH,CAC6B1B,EAAMC,KAAN,CAAY0B,WAAZ,EAD7B,EAEKL,IAFL,CAEU,SAACM,CAAD,CAAY,CAChBJ,EAAYK,GAAZ,CAAkBD,CADF,CAEhBE,EAAoBN,CAApB,CACD,CALL,CAMD,CATD,CAUD,CAEGJ,CAf8C,EAgBhDC,GAhBgD,CAmBlDJ,EAAWc,GAAX,iCAA+CC,EAAKC,IAApD,KAA6DZ,CAA7D,CACD,CAED,QAASa,EAAT,CAA2Bf,CAA3B,CAAyCC,CAAzC,CAAoD,CAElD,QAASe,EAAT,EAAqB,CACnBhB,EAAanB,KAAb,GACGsB,IADH,CACQ,kBAASc,GAAWpC,CAAX,CAAT,CADR,CAED,CAEGoB,CAP8C,EAQhDe,GARgD,CAWlDlB,EAAWc,GAAX,oCAAkDC,EAAKC,IAAvD,KAAgEE,CAAhE,CACD,CAED,QAASE,EAAT,EAA0B,CACxB,MAAO,IAAIC,QAAJ,CAAY,SAACC,CAAD,CAAUC,CAAV,CAAqB,CACtC,GAAIC,SAAJ,CAEgB,IAAZ,IAAKC,GAH6B,CAuBpCF,EAAO,EAAP,CAvBoC,EAIpCC,EAAmBT,EAAKpC,mBAAmBC,YAAxB,EAAsC8C,aAAtC,CAAoDX,CAApD,CAJiB,CAKpCS,EACGnB,IADH,CACQ,SAACsB,CAAD,CAAgB,CACpB,GAAMxB,GAAYwB,EAAWxB,SAA7B,CACAY,EAAKpC,mBAAmBG,mBAAxB,EAA+C6C,CAF3B,CAGpB1B,EAAkB0B,EAAWzB,YAA7B,CAA2CC,CAA3C,CAHoB,CAIpBc,EAAkBU,EAAWzB,YAA7B,CAA2CC,CAA3C,CAJoB,CAKpBmB,GACD,CAPH,EAQGM,KARH,CAQS,SAACC,CAAD,CAAW,CAChBd,EAAKpC,mBAAmBO,QAAxB,EAAkC4C,GAAlC,CAAsCf,EAAKC,IAA3C,CAAiDxC,0BAA0BqD,CAA1B,CAAjD,CAAmF,OAAnF,CADgB,CAGhBE,QAAQC,GAAR,CAAY,EAAZ,CAHgB,CAIhBD,QAAQC,GAAR,CAAY,sBAAZ,CAJgB,CAKhBD,QAAQC,GAAR,CAAejB,EAAKC,IAApB,MAA6BxC,0BAA0BqD,CAA1B,CAA7B,CALgB,CAOhBN,EAAO/C,0BAA0BqD,CAA1B,CAAP,CACD,CAhBH,CALoC,CAyBvC,CAzBM,CA0BR,CAzEmF,0CACpF,GACEd,GAAO,IADT,CAEER,IAFF,CAIEY,QAJF,CAKEb,QALF,CAMEO,QANF,CAOEoB,EAA2B,IAP7B,CA0EA,KAAKtD,mBAAmBC,YAAxB,EAAwCmB,CA3E4C,CA4EpF,KAAKpB,mBAAmBI,KAAxB,EAAiC,GAAIsC,QAAJ,CAAY,kBAAYF,GAAaG,CAAzB,CAAZ,CA5EmD,CA6EpF,KAAK3C,mBAAmBK,KAAxB,EAAiC,GAAIqC,QAAJ,CAAY,kBAAYf,GAAagB,CAAzB,CAAZ,CA7EmD,CA8EpF,KAAK3C,mBAAmBM,cAAxB,EAA0C,GAAIoC,QAAJ,CAAY,kBAAYR,GAAsBS,CAAlC,CAAZ,CA9E0C,CA+EpF,KAAK3C,mBAAmBO,QAAxB,EAAoCA,CA/EgD,CAgFpF,KAAKP,mBAAmBQ,WAAxB,EAAuCA,CAhF6C,CAkFpF,KAAK6B,IAAL,CAAYlB,EAAiBkB,IAlFuD,CAmFpF,KAAKS,GAAL,CAAW3B,EAAiB2B,GAnFwD,CAoFpF,KAAKS,SAAL,CAAiBpC,EAAiBqC,QAAjB,CAA0BC,SApFyC,CAqFpF,KAAKC,QAAL,CAAgBvC,EAAiBqC,QAAjB,CAA0BG,IArF0C,CAsFpF,KAAKC,QAAL,CAAgBzC,EAAiBqC,QAAjB,CAA0BI,QAtF0C,CAuFpF,KAAK9D,gBAAL,CAAwBA,gBAvF4D,CAyFpF,KAAK+D,eAAL,CAAuB,UAAM,CAI3B,MAHgC,KAA5B,GAGJ,GAFEP,EAA2Bb,GAE7B,EAAOa,CACR,CAEF,C,8FAEgB,gBACf,MAAO,IAAIZ,QAAJ,CAAY,SAACC,CAAD,CAAa,CAC9B,MAAK3C,mBAAmBC,YAAxB,EAAsC6D,cAAtC,QACGpC,IADH,CACQ,UAAM,CACViB,EAAQ,CACNoB,OAAQ,SADF,CAENC,QAAS,sBAFH,CAGNC,MAAO,SAHD,CAAR,CAID,CANH,EAOGhB,KAPH,CAOS,SAACC,CAAD,CAAW,CAChBP,EAAQ,CACNoB,OAAQ,OADF,CAENC,QAASnE,0BAA0BqD,CAA1B,CAFH,CAGNe,MAAO,OAHD,CAAR,CAID,CAZH,CAaD,CAdM,CAeR,C,oCAEKC,C,CAAS,CAGb,QAASC,EAAT,CAA6BC,CAA7B,CAAqCC,CAArC,CAAkD,CAChD,GACEC,GAAclC,EAAKpC,mBAAmBG,mBAAxB,EAA6CoE,QAD7D,CAEEC,EAAWpC,EAAKqC,WAAL,CAAiBL,CAAjB,EAAyB1C,IAAzB,CAA8B,kBAA0B,KAAZ,GAAD,CAAqC,IAArC,CAAqBgD,EAASrC,IAA3C,CAA9B,CAFb,CAGEsC,EAAqBvC,EAAKwC,WAAL,CAAiBR,CAAjB,EAAyB1C,IAAzB,CAA8B,SAACmD,CAAD,CAAiB,CAClE,GAAMC,GAAcR,EAAYS,iBAAZ,CAA8BF,CAA9B,CAA2CR,CAA3C,CAApB,CACA,MAAuB,KAAf,GAAD,CAAkD,IAAlD,CAAwBS,EAAYE,WAC5C,CAHoB,CAHvB,CAQA,MAAOtC,SAAQT,GAAR,CAAY,CAACuC,CAAD,CAAWG,CAAX,CAAZ,EACJjD,IADI,CACC,SAACoD,CAAD,CAAiB,CACrB,GACEN,GAAWM,EAAY,CAAZ,CADb,CAC0C;AACxCH,EAAqBG,EAAY,CAAZ,CAFvB,CAE0C;AAHrB,MAKJ,KAAZ,GAAD,EAA6C,IAAtB,GALN,CAMZ,CACLN,UADK,CAELG,oBAFK,CANY,CAYd,IACR,CAdI,CAeR,CAED,QAASM,EAAT,CAA6BC,CAA7B,CAAqC,CACnC,MAAOC,QAAOC,IAAP,CAAYF,CAAZ,EAAoBG,IAApB,CAAyB,kBAAa,OAAOC,CAAP,CAAb,CAAzB,CACR,CAED,QAASC,EAAT,CAA2BC,CAA3B,CAAuCC,CAAvC,CAA8CX,CAA9C,CAA2D,CACzD,GAAIY,GAAgBZ,EAAYN,QAA5B,OAA0CM,EAAYH,kBAA1D,CAOA,MALkB,KAAd,GAKJ,GAJEe,EAAgBtD,EAAKC,IAArB,OAA+BqD,CAIjC,EAFAA,EAAaD,GAASC,CAEtB,CAAOA,CACR,CAED,QAASC,EAAT,CAA0BC,CAA1B,CAA0CC,CAA1C,CAAsD,CACpD,MAAUD,EAAV,MAA6BnF,2BAA2BoF,CAA3B,CAC9B,CAED,QAASC,EAAT,CAAgC1B,CAAhC,CAAwCC,CAAxC,CAAqD0B,CAArD,CAA4Db,CAA5D,CAAoE,CAClE,GAAMc,GAAY5D,EAAKpC,mBAAmBG,mBAAxB,EAA6C8F,MAA/D,CADkE,MAG9D,OAAoBf,CAApB,CAH8D,CAIzDxC,QAAQC,OAAR,IAJyD,CAO3DqD,EAAUE,mBAAV,CAA8B9B,CAA9B,CAAsCC,CAAtC,CAAmD0B,EAAMI,IAAzD,CAA+DJ,EAAMK,EAArE,CAC8BL,EAAMM,UADpC,CACgDN,EAAMO,cADtD,CACsEpB,CADtE,EAEJxD,IAFI,CAEC,SAAC6E,CAAD,CAAgB,CAA0C;AAC9D,MAAOpB,QAAOC,IAAP,CAAYmB,EAAWC,MAAvB,EAA+BC,GAA/B,CAAmC,SAACZ,CAAD,CAAgB,CAAI;AAC5D,MAAO,CACLA,YADK,CAELU,WAAY,CACVG,OAAQH,EAAWG,MADT,CAEVF,OAAQD,EAAWC,MAAX,CAAkBX,CAAlB,CAFE,CAFP,CAOR,CARM,CASR,CAZI,CAaR,CAED,QAASc,EAAT,CAA4BC,CAA5B,CAAoCb,CAApC,CAA2Cb,CAA3C,CAAmD,CACjD,GAAM2B,GAAgBzE,EAAK0E,oBAAL,CAA0BF,EAAOG,MAAjC,CAAtB,CACIC,EAAkB,IADtB,CA2BA,MAxBK,OAAOC,IAAR,EAA2B,OAAOC,mBAwBtC,GAtBEF,EAAkB7C,EAAoB0C,CAApB,CAAmCD,EAAOvC,WAA1C,EACf3C,IADe,CACV,SAACoD,CAAD,CAAiB,CACrB,GACEqC,GAAQ,IADV,CAEEzB,QAFF,CAGE0B,QAHF,CAIEC,QAJF,CAgBA,MAVmB,KAAf,GAUJ,GATE3B,EAAaH,EAAkBqB,EAAOpB,UAAzB,CAAqCoB,EAAOnB,KAA5C,CAAmDX,CAAnD,CASf,CAREqC,EAAQ,CAACzE,QAAQC,OAAR,CAAgB+C,CAAhB,CAAD,CAQV,CAPE2B,EAAyB,IAAV,GAAD,CAAmBlC,OAAOmC,MAAP,CAAc,IAAd,CAAnB,CAAyCpC,CAOzD,CANEmC,EAAcnG,oBAAoBqG,mBAApB,CAAwCF,CAAxC,CAMhB,CALED,EAAkBtB,EAAuBe,CAAvB,CAAsCD,EAAOvC,WAA7C,CAA0D0B,CAA1D,CAAiEsB,CAAjE,CAKpB,CAJEF,EAAMK,IAAN,CAAWJ,CAAX,CAIF,CAHED,EAAQzE,QAAQT,GAAR,CAAYkF,CAAZ,CAGV,EAAOA,CACR,CAnBe,CAsBpB,EAAOH,CACR,CAED,QAASS,EAAT,CAAwBC,CAAxB,CAAiC3B,CAAjC,CAAwC4B,CAAxC,CAAiD,CAC/C,GAAMC,KAAN,CAUA,MATAF,GAAQG,OAAR,CAAgB,SAACjB,CAAD,CAAY,CAC1B,GACE1B,GAAU,MAAD,CAAqB,CAAEvE,MAAF,CAArB,CAAqCiG,EAAO1B,MADvD,CAEE8B,EAAkBL,EAAmBC,CAAnB,CAA2Bb,CAA3B,CAAkCb,CAAlC,CAFpB,CAIuB,IAAnB,GALsB,EAMxB0C,EAAOJ,IAAP,CAAYR,CAAZ,CAEH,CARD,CASA,CAAOY,CACR,CAED,QAASE,EAAT,CAA0BC,CAA1B,CAA4CJ,CAA5C,CAAqD,CACnD,GACEK,GAAgB7C,OAAOmC,MAAP,CAAc,IAAd,CADlB,CAEEtB,EAAY5D,EAAKpC,mBAAmBG,mBAAxB,EAA6C8F,MAF3D,CA8BA,MA1BA+B,GAAcC,IAAd,GA0BA,CAxByB,IAApB,GAAD,EAAyD,CAA1B,GAAiBC,MAwBpD,EAvBEH,EAAiBF,OAAjB,CAAyB,SAACjB,CAAD,CAAY,CACnC,GACEhB,GAA4B,IAAV,GAAD,CAA+B,IAA/B,CAAmBgB,EAAO,CAAP,CADtC,CAEEuB,EAA0B,IAAV,GAAD,CAA+B,IAA/B,CAAmBvB,EAAO,CAAP,CAFpC,CAIIlB,QAJJ,CAMc,IAAV,GAP+B,EAQjCyC,EAAaN,OAAb,CAAqB,SAAC3C,CAAD,CAAY,CAE7BQ,CAF6B,CAC3B,IALgB,CAACiC,CAIU,CAEhBhC,EAAiBC,CAAjB,CAAiCV,EAAOW,UAAxC,CAFgB,CAIhBD,CAJgB,CAM/BoC,EAAcC,IAAd,CAAmBT,IAAnB,CAAwB,CACtBZ,OAAQlB,CADc,CAEtB0C,WAAYpC,EAAUqC,oBAAV,CAA+BnD,EAAOqB,UAAtC,CAFU,CAAxB,CAID,CAVD,CAYH,CApBD,CAuBF,CAAOyB,CACR,CAED,QAASM,EAAT,CAAsBC,CAAtB,CAAoC,CAElC,GAGEtC,GAAS7D,EAAKpC,mBAAmBG,mBAAxB,EAA6C8F,MAHxD,CAIEyB,EAAUa,EAAab,OAAb,IAJZ,CAKEc,EAAgBD,EAAaE,UAAb,IALlB,CAMEd,EAAoC,IAAzB,IAAcA,OAAzB,EAAoDa,EAAcb,OANpE,CAOEe,EAAsD,IAAlC,IAAcA,gBAAlC,EAAsEF,EAAcE,gBAPtF,CAQEC,EAAgBH,EAAcG,aARhC,CASEC,EAAYL,EAAaxC,KAAb,CAAmBI,IAAnB,CAAwB0C,OAAxB,CAAgC,QAAhC,CATd,CAUEC,EAAUP,EAAaxC,KAAb,CAAmBK,EAAnB,CAAsByC,OAAtB,CAA8B,QAA9B,CAVZ,CAaE9C,QAbF,CAcEgD,IAdF,CAkBA,GAFAhD,EAAQE,EAAO+C,gBAAP,CAAwBJ,CAAxB,CAAmCE,CAAnC,CAA4CnB,CAA5C,CAAqDe,EAAmBC,CAAnB,CAAmC,IAAxF,CAER,CAAmB,IAAf,IAAMzF,KAAV,CACE6C,EAAQA,EAAM6B,MADhB,CAEEmB,EAAcA,EAAYE,MAAZ,CAAmBxB,EAAeC,CAAf,CAAwB3B,CAAxB,CAA+B4B,CAA/B,CAAnB,CAFhB,KAGO,CACL;AACA,GAAMuB,GAAgB,yDAA6CnD,EAAM7C,KAAN,CAAYoD,cAAzD,CAA0E,GAA1E,CACAP,EAAM7C,KAAN,CAAYiG,UADZ,CACyB,GAD/C,CAEA/G,EAAKpC,mBAAmBO,QAAxB,EAAkC4C,GAAlC,CAxBwC,yBAwBxC,CAA6E+F,CAA7E,CAA4F,SAA5F,CACD,CAED,MAAOxG,SAAQT,GAAR,CAAY8G,CAAZ,EACJrH,IADI,CACC,kBAAoBoG,GAAiBC,CAAjB,CAAmCJ,CAAnC,CAApB,CADD,CAER,CApLD,GAAMvF,GAAO,IAAb,CAsLA,GAAI,CACF,MAAO,MAAKyB,eAAL,GACJnC,IADI,CACC,iBAAM4G,GAAapE,CAAb,CAAN,CADD,CAER,CAAC,MAAOhB,CAAP,CAAc,CACd,MAAOR,SAAQE,MAAR,CAAeM,CAAf,CACR,CACF,C,wDAEeiE,C,CAAO,iBACrB,MAAO,MAAKtD,eAAL,GACJnC,IADI,CACC,UAAM,OAEG,KAAT,GAFM,CAGDgB,QAAQC,OAAR,IAHC,CAMH,GAAI5C,yBAAJ,QAAmCoH,CAAnC,EAA0CiC,OAA1C,EAER,CATI,CAUR,C,qCAEO,iBACN,MAAO,MAAKvF,eAAL,GACJnC,IADI,CACC,iBAAM,QAAK1B,mBAAmBI,KAAxB,CAAN,CADD,CAER,C,qCAEO,iBACN,MAAO,MAAKyD,eAAL,GACJnC,IADI,CACC,iBAAM,QAAK1B,mBAAmBM,cAAxB,CAAN,CADD,CAER,C,2DAEkB,iBACjB,MAAO,MAAKN,mBAAmBQ,WAAxB,EAAqC6I,SAArC,CACJC,MADI,CACG,kBAAa,QAAKC,4BAAL,CAAkCC,EAAShE,UAA3C,IAA2D,OAAKnD,IAA7E,CADH,EAEJiH,MAFI,CAEG,kBAAaE,GAASrC,KAAT,CAAesC,KAAf,CAAqB,yBAArB,CAAb,CAFH,CAGR,C,sDAEcrF,C,CAAQ,CACrB,MAAS,CAACsF,OAAOC,SAAP,CAAiBvF,CAAjB,CAAF,EACoF,CAAnF,OAAKwF,gBAAL,GAAwBC,SAAxB,CAAkC,kBAAa,IAAeL,EAASnH,IAAxB,IAAb,CAAlC,CACV,C,kFAE4ByH,C,CAAgB,CAC3C,MAAO,MAAK9J,mBAAmBQ,WAAxB,EAAqCuJ,OAArC,CAA6CD,CAA7C,CACR,C,kEAEoB1F,C,CAAQ,CAE3B,GAAIsF,OAAOC,SAAP,CAAiBvF,CAAjB,CAAJ,CACE,MAAOA,EAAP,CACK,GAAI,KAAK4F,cAAL,CAAoB5F,CAApB,CAAJ,CAAiC,CACtC,GAAM6F,GAAgB,KAAKjK,mBAAmBQ,WAAxB,EAAqCuJ,OAArC,CAA6C3F,CAA7C,CAAtB,CACI8F,GAAiBD,CADrB,CADsC,MAIlCP,QAAOC,SAAP,CAAiBO,CAAjB,CAJkC,CAK7BA,CAL6B,EAQtCA,EAAUD,EAAcR,KAAd,CAAoB,UAApB,CAR4B,CAStCS,EAAuB,IAAX,GAAD,EAAyC,CAAnB,KAAQhC,MAA/B,CAAgDgC,EAAQ,CAAR,EAAWC,KAAX,CAAiB,GAAjB,CAAhD,CAAwE,IAT5C,CAUtCD,EAAuB,IAAX,GAAD,EAAuC,CAAjB,GAAQhC,MAA/B,EAAqDgC,EAAQ,CAAR,CAArD,CAAmE,IAVvC,CAY/BA,CAZ+B,CAavC,CAED,MAAO,KACR,C,gDAEW9F,C,CAAQ,iBAClB,MAAO,MAAKP,eAAL,GACJnC,IADI,CACC,iBAAM,QAAK1B,mBAAmBK,KAAxB,CAAN,CADD,EAEJqB,IAFI,CAEC,kBAASrB,GAAMoE,WAAN,CAAkB,OAAKqC,oBAAL,CAA0B1C,CAA1B,CAAlB,CAAT,CAFD,CAGR,C,gDAEWA,C,CAA0B,iBAAlB5C,CAAkB,2DACpC,MAAO,MAAKqC,eAAL,GACJnC,IADI,CACC,iBAAM,QAAK1B,mBAAmBG,mBAAxB,EAA6CoE,QAA7C,CACT6F,sBADS,CACc,OAAKtD,oBAAL,CAA0B1C,CAA1B,CADd,CACiD5C,CADjD,CAAN,CADD,CAGR,C,kEAE0B0D,C,CAAQ,CACjC,GAEEmF,GAASnF,GAAUC,OAAOmC,MAAP,CAAc,IAAd,CAFrB,CAOA,MAHA,oDAAMO,OAAN,CAAc,SAACyC,CAAD,CAAU,CACtBD,EAAOC,CAAP,EAAgC,IAAhB,IAAOA,CAAP,CAAhB,EAAgDD,EAAOC,CAAP,CACjD,CAFD,CAGA,CAAOD,CACR,C,4BAIHnJ,oBAAoBqJ,OAApB,CAA8BtJ,wB,+BAG5BC,mB","file":"datasource.js","sourcesContent":["/**\r\n * @license\r\n * Copyright AdRem Software. All Rights Reserved.\r\n *\r\n * Use of this source code is governed by an Apache License, Version 2.0 that can be\r\n * found in the LICENSE file.\r\n */\r\n\r\nimport { CONNECTION_ERROR_MESSAGES, MAX_SAMPLE_COUNT } from './services/netCrunchAPI/module';\r\nimport { NetCrunchMetricFindQuery } from './templateQuery/metricFindQuery';\r\n\r\nconst\r\n  PRIVATE_PROPERTIES = {\r\n    netCrunchAPI: Symbol('netCrunchAPI'),\r\n    netCrunchConnection: Symbol('netCrunchConnection'),\r\n    atlas: Symbol('atlas'),\r\n    nodes: Symbol('nodes'),\r\n    processedNodes: Symbol('processedNodes'),\r\n    alertSrv: Symbol('alertSrv'),\r\n    templateSrv: Symbol('templateSrv')\r\n  },\r\n  SERIES_TYPES_DISPLAY_NAMES = {\r\n    min: 'Min',\r\n    avg: 'Avg',\r\n    max: 'Max',\r\n    avail: 'Avail',\r\n    delta: 'Delta',\r\n    equal: 'Equal',\r\n    distr: 'Distr'\r\n  },\r\n  NET_CRUNCH_DATASOURCE_DI = ['instanceSettings', 'netCrunchAPIService', 'alertSrv', 'templateSrv', '$rootScope'];\r\n\r\nclass NetCrunchDatasource {\r\n\r\n  constructor(instanceSettings, netCrunchAPIService, alertSrv, templateSrv, $rootScope) {\r\n    const\r\n      self = this,\r\n      nodesBuffer = {};\r\n    let\r\n      atlasReady,\r\n      nodesReady,\r\n      processedNodesReady,\r\n      datasourceInitialization = null;\r\n\r\n    function initNodesUpdating(networkAtlas, fromCache) {\r\n\r\n      function updateNodes() {\r\n        networkAtlas.atlas().then((atlas) => {\r\n          nodesReady(atlas.nodes);\r\n          nodesBuffer.operations = atlas.nodes.operations;\r\n          nodesBuffer.operations\r\n            .asyncSortByNameAndAddress(atlas.nodes.getAllNodes())\r\n              .then((sorted) => {\r\n                nodesBuffer.all = sorted;\r\n                processedNodesReady(nodesBuffer);\r\n              });\r\n        });\r\n      }\r\n\r\n      if (fromCache) {\r\n        updateNodes();\r\n      }\r\n\r\n      $rootScope.$on(`netcrunch-nodes-data-changed(${self.name})`, updateNodes);\r\n    }\r\n\r\n    function initAtlasUpdating(networkAtlas, fromCache) {\r\n\r\n      function initAtlas() {\r\n        networkAtlas.atlas()\r\n          .then(atlas => atlasReady(atlas));\r\n      }\r\n\r\n      if (fromCache) {\r\n        initAtlas();\r\n      }\r\n\r\n      $rootScope.$on(`netcrunch-networks-data-changed(${self.name})`, initAtlas);\r\n    }\r\n\r\n    function initDatasource() {\r\n      return new Promise((resolve, reject) => {\r\n        let netCrunchSession;\r\n\r\n        if (self.url != null) {\r\n          netCrunchSession = self[PRIVATE_PROPERTIES.netCrunchAPI].getConnection(self);\r\n          netCrunchSession\r\n            .then((connection) => {\r\n              const fromCache = connection.fromCache;\r\n              self[PRIVATE_PROPERTIES.netCrunchConnection] = connection;\r\n              initNodesUpdating(connection.networkAtlas, fromCache);\r\n              initAtlasUpdating(connection.networkAtlas, fromCache);\r\n              resolve();\r\n            })\r\n            .catch((error) => {\r\n              self[PRIVATE_PROPERTIES.alertSrv].set(self.name, CONNECTION_ERROR_MESSAGES[error], 'error');\r\n              /* eslint-disable no-console */\r\n              console.log('');\r\n              console.log('NetCrunch datasource');\r\n              console.log(`${self.name}: ${CONNECTION_ERROR_MESSAGES[error]}`);\r\n              /* eslint-enable no-console */\r\n              reject(CONNECTION_ERROR_MESSAGES[error]);\r\n            });\r\n        } else {\r\n          reject('');\r\n        }\r\n      });\r\n    }\r\n\r\n    this[PRIVATE_PROPERTIES.netCrunchAPI] = netCrunchAPIService;\r\n    this[PRIVATE_PROPERTIES.atlas] = new Promise(resolve => (atlasReady = resolve));\r\n    this[PRIVATE_PROPERTIES.nodes] = new Promise(resolve => (nodesReady = resolve));\r\n    this[PRIVATE_PROPERTIES.processedNodes] = new Promise(resolve => (processedNodesReady = resolve));\r\n    this[PRIVATE_PROPERTIES.alertSrv] = alertSrv;\r\n    this[PRIVATE_PROPERTIES.templateSrv] = templateSrv;\r\n\r\n    this.name = instanceSettings.name;\r\n    this.url = instanceSettings.url;\r\n    this.serverUrl = instanceSettings.jsonData.simpleUrl;\r\n    this.username = instanceSettings.jsonData.user;\r\n    this.password = instanceSettings.jsonData.password;\r\n    this.MAX_SAMPLE_COUNT = MAX_SAMPLE_COUNT;\r\n\r\n    this.datasourceReady = () => {\r\n      if (datasourceInitialization == null) {\r\n        datasourceInitialization = initDatasource();\r\n      }\r\n      return datasourceInitialization;\r\n    };\r\n\r\n  }\r\n\r\n  testDatasource() {\r\n    return new Promise((resolve) => {\r\n      this[PRIVATE_PROPERTIES.netCrunchAPI].testConnection(this)\r\n        .then(() => {\r\n          resolve({\r\n            status: 'success',\r\n            message: 'Datasource connected',\r\n            title: 'Success' });\r\n        })\r\n        .catch((error) => {\r\n          resolve({\r\n            status: 'error',\r\n            message: CONNECTION_ERROR_MESSAGES[error],\r\n            title: 'Error' });\r\n        });\r\n    });\r\n  }\r\n\r\n  query(options) {\r\n    const self = this;\r\n\r\n    function validateCounterData(nodeId, counterName) {\r\n      const\r\n        countersAPI = self[PRIVATE_PROPERTIES.netCrunchConnection].counters,\r\n        nodeName = self.getNodeById(nodeId).then(nodeData => ((nodeData != null) ? nodeData.name : null)),\r\n        counterDisplayName = self.getCounters(nodeId).then((counterList) => {\r\n          const counterData = countersAPI.findCounterByName(counterList, counterName);\r\n          return (counterData != null) ? counterData.displayName : null;\r\n        });\r\n\r\n      return Promise.all([nodeName, counterDisplayName])\r\n        .then((counterData) => {\r\n          const\r\n            nodeName = counterData[0],              // eslint-disable-line\r\n            counterDisplayName = counterData[1];    // eslint-disable-line\r\n\r\n          if ((nodeName != null) && (counterDisplayName != null)) {\r\n            return {\r\n              nodeName,\r\n              counterDisplayName\r\n            };\r\n          }\r\n\r\n          return null;\r\n        });\r\n    }\r\n\r\n    function seriesTypesSelected(series) {\r\n      return Object.keys(series).some(seriesKey => series[seriesKey] === true);\r\n    }\r\n\r\n    function prepareSeriesName(datasource, alias, counterData) {\r\n      let seriesName = `${counterData.nodeName} - ${counterData.counterDisplayName}`;\r\n\r\n      if (datasource != null) {\r\n        seriesName = `${self.name} - ${seriesName}`;\r\n      }\r\n      seriesName = alias || seriesName;\r\n\r\n      return seriesName;\r\n    }\r\n\r\n    function extendSeriesName(baseSeriesName, seriesType) {\r\n      return `${baseSeriesName}\\\\${SERIES_TYPES_DISPLAY_NAMES[seriesType]}`;\r\n    }\r\n\r\n    function prepareSeriesDataQuery(nodeId, counterName, range, series) {\r\n      const trendsAPI = self[PRIVATE_PROPERTIES.netCrunchConnection].trends;\r\n\r\n      if (seriesTypesSelected(series) === false) {\r\n        return Promise.resolve([]);\r\n      }\r\n\r\n      return trendsAPI.getCounterTrendData(nodeId, counterName, range.from, range.to,\r\n                                           range.periodType, range.periodInterval, series)\r\n        .then((dataPoints) => {                                         // eslint-disable-line\r\n          return Object.keys(dataPoints.values).map((seriesType) => {   // eslint-disable-line\r\n            return {\r\n              seriesType,\r\n              dataPoints: {\r\n                domain: dataPoints.domain,\r\n                values: dataPoints.values[seriesType]\r\n              }\r\n            };\r\n          });\r\n        });\r\n    }\r\n\r\n    function prepareTargetQuery(target, range, series) {\r\n      const decodedNodeId = self.decodeNodeIdTemplate(target.nodeID);\r\n      let targetDataQuery = null;\r\n\r\n      if ((target.hide !== true) && (target.counterDataComplete === true)) {\r\n\r\n        targetDataQuery = validateCounterData(decodedNodeId, target.counterName)\r\n          .then((counterData) => {\r\n            let\r\n              query = null,\r\n              seriesName,\r\n              seriesDataQuery,\r\n              seriesTypes;\r\n\r\n            if (counterData != null) {\r\n              seriesName = prepareSeriesName(target.datasource, target.alias, counterData);\r\n              query = [Promise.resolve(seriesName)];\r\n              seriesTypes = (series == null) ? Object.create(null) : series;\r\n              seriesTypes = NetCrunchDatasource.validateSeriesTypes(seriesTypes);\r\n              seriesDataQuery = prepareSeriesDataQuery(decodedNodeId, target.counterName, range, seriesTypes);\r\n              query.push(seriesDataQuery);\r\n              query = Promise.all(query);\r\n            }\r\n\r\n            return query;\r\n          });\r\n      }\r\n\r\n      return targetDataQuery;\r\n    }\r\n\r\n    function prepareQueries(targets, range, rawData) {\r\n      const result = [];\r\n      targets.forEach((target) => {\r\n        const\r\n          series = (rawData === true) ? { avg: true } : target.series,\r\n          targetDataQuery = prepareTargetQuery(target, range, series);\r\n\r\n        if (targetDataQuery != null) {\r\n          result.push(targetDataQuery);\r\n        }\r\n      });\r\n      return result;\r\n    }\r\n\r\n    function prepareChartData(targetsChartData, rawData) {\r\n      const\r\n        counterSeries = Object.create(null),\r\n        trendsAPI = self[PRIVATE_PROPERTIES.netCrunchConnection].trends;\r\n\r\n      counterSeries.data = [];\r\n\r\n      if ((targetsChartData != null) && (targetsChartData.length > 0)) {\r\n        targetsChartData.forEach((target) => {\r\n          const\r\n            baseSeriesName = (target != null) ? target[0] : null,\r\n            targetSeries = (target != null) ? target[1] : null,\r\n            extendedSeriesNames = !rawData;\r\n          let seriesName;\r\n\r\n          if (target != null) {\r\n            targetSeries.forEach((series) => {\r\n              if (extendedSeriesNames === true) {\r\n                seriesName = extendSeriesName(baseSeriesName, series.seriesType);\r\n              } else {\r\n                seriesName = baseSeriesName;\r\n              }\r\n              counterSeries.data.push({\r\n                target: seriesName,\r\n                datapoints: trendsAPI.grafanaDataConverter(series.dataPoints)\r\n              });\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      return counterSeries;\r\n    }\r\n\r\n    function performQuery(queryOptions) {\r\n\r\n      const\r\n        RAW_TIME_RANGE_EXCEEDED_WARNING_TITLE = 'Time range is too long.',\r\n        RAW_TIME_RANGE_EXCEEDED_WARNING_TEXT = 'Maximum allowed length of time range for RAW data is ',\r\n        trends = self[PRIVATE_PROPERTIES.netCrunchConnection].trends,\r\n        targets = queryOptions.targets || [],\r\n        globalOptions = queryOptions.scopedVars || {},\r\n        rawData = (globalOptions.rawData == null) ? false : globalOptions.rawData,\r\n        setMaxDataPoints = (globalOptions.setMaxDataPoints == null) ? false : globalOptions.setMaxDataPoints,\r\n        maxDataPoints = globalOptions.maxDataPoints,\r\n        rangeFrom = queryOptions.range.from.startOf('minute'),\r\n        rangeTo = queryOptions.range.to.startOf('minute');\r\n\r\n      let\r\n        range,\r\n        dataQueries = [];\r\n\r\n      range = trends.prepareTimeRange(rangeFrom, rangeTo, rawData, setMaxDataPoints ? maxDataPoints : null);\r\n\r\n      if (range.error == null) {\r\n        range = range.result;\r\n        dataQueries = dataQueries.concat(prepareQueries(targets, range, rawData));\r\n      } else {\r\n        // eslint-disable-next-line\r\n        const ERROR_MESSAGE = RAW_TIME_RANGE_EXCEEDED_WARNING_TEXT + ' ' + range.error.periodInterval + ' ' +\r\n                              range.error.periodName + '.';\r\n        self[PRIVATE_PROPERTIES.alertSrv].set(RAW_TIME_RANGE_EXCEEDED_WARNING_TITLE, ERROR_MESSAGE, 'warning');\r\n      }\r\n\r\n      return Promise.all(dataQueries)\r\n        .then(targetsChartData => prepareChartData(targetsChartData, rawData));\r\n    }\r\n\r\n    try {\r\n      return this.datasourceReady()\r\n        .then(() => performQuery(options));\r\n    } catch (error) {\r\n      return Promise.reject(error);\r\n    }\r\n  }\r\n\r\n  metricFindQuery(query) {\r\n    return this.datasourceReady()\r\n      .then(() => {\r\n\r\n        if (query == null) {\r\n          return Promise.resolve([]);\r\n        }\r\n\r\n        return new NetCrunchMetricFindQuery(this, query).process();\r\n\r\n      });\r\n  }\r\n\r\n  atlas() {\r\n    return this.datasourceReady()\r\n      .then(() => this[PRIVATE_PROPERTIES.atlas]);\r\n  }\r\n\r\n  nodes() {\r\n    return this.datasourceReady()\r\n      .then(() => this[PRIVATE_PROPERTIES.processedNodes]);\r\n  }\r\n\r\n  getNodeVariables() {\r\n    return this[PRIVATE_PROPERTIES.templateSrv].variables\r\n      .filter(variable => (this.decodeDatasourceNameTemplate(variable.datasource) === this.name))\r\n      .filter(variable => (variable.query.match(/^[nN][oO][dD][eE][sS].*/)));\r\n  }\r\n\r\n  isNodeTemplate(nodeId) {\r\n    return ((!Number.isInteger(nodeId)) &&\r\n            (this.getNodeVariables().findIndex(variable => (nodeId === `$${variable.name}`)) >= 0));\r\n  }\r\n\r\n  decodeDatasourceNameTemplate(datasourceName) {\r\n    return this[PRIVATE_PROPERTIES.templateSrv].replace(datasourceName);\r\n  }\r\n\r\n  decodeNodeIdTemplate(nodeId) {\r\n\r\n    if (Number.isInteger(nodeId)) {\r\n      return nodeId;\r\n    } else if (this.isNodeTemplate(nodeId)) {\r\n      const templateValue = this[PRIVATE_PROPERTIES.templateSrv].replace(nodeId);\r\n      let idValue = Number(templateValue);\r\n\r\n      if (Number.isInteger(idValue)) {\r\n        return idValue;\r\n      }\r\n\r\n      idValue = templateValue.match(/^{(.*)}$/);\r\n      idValue = ((idValue != null) && (idValue.length === 2)) ? idValue[1].split(',') : null;\r\n      idValue = ((idValue != null) && (idValue.length > 0)) ? Number(idValue[0]) : null;\r\n\r\n      return idValue;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  getNodeById(nodeId) {\r\n    return this.datasourceReady()\r\n      .then(() => this[PRIVATE_PROPERTIES.nodes])\r\n      .then(nodes => nodes.getNodeById(this.decodeNodeIdTemplate(nodeId)));\r\n  }\r\n\r\n  getCounters(nodeId, fromCache = true) {\r\n    return this.datasourceReady()\r\n      .then(() => this[PRIVATE_PROPERTIES.netCrunchConnection].counters\r\n        .getCountersForMonitors(this.decodeNodeIdTemplate(nodeId), fromCache));\r\n  }\r\n\r\n  static validateSeriesTypes(series) {\r\n    const\r\n      types = ['min', 'avg', 'max', 'avail', 'delta', 'equal', 'distr'],\r\n      buffer = series || Object.create(null);\r\n\r\n    types.forEach((type) => {\r\n      buffer[type] = (buffer[type] == null) ? false : buffer[type];\r\n    });\r\n    return buffer;\r\n  }\r\n\r\n}\r\n\r\nNetCrunchDatasource.$inject = NET_CRUNCH_DATASOURCE_DI;\r\n\r\nexport {\r\n  NetCrunchDatasource\r\n};\r\n"]}