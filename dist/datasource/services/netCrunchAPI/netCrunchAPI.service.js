'use strict';System.register(['angular','../../common','./adrem/module','./connectionCache','./netCrunchConnection/connection'],function(_export,_context){'use strict';var angular,servicesModule,NetCrunchConnectionCache,NetCrunchConnection,CONNECTION_CONSTS,NETCRUNCH_TREND_DATA_CONST,_createClass,CONNECTION_ERROR_MESSAGES,MAX_SAMPLE_COUNT,NET_CRUNCH_API_SERVICE_DI,NetCrunchAPIService;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}return{setters:[function(_angular){angular=_angular.default},function(_common){servicesModule=_common.servicesModule},function(_adremModule){},function(_connectionCache){NetCrunchConnectionCache=_connectionCache.NetCrunchConnectionCache},function(_netCrunchConnectionConnection){NetCrunchConnection=_netCrunchConnectionConnection.NetCrunchConnection;CONNECTION_CONSTS=_netCrunchConnectionConnection.CONNECTION_CONSTS;NETCRUNCH_TREND_DATA_CONST=_netCrunchConnectionConnection.NETCRUNCH_TREND_DATA_CONST}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();_export('CONNECTION_ERROR_MESSAGES',CONNECTION_ERROR_MESSAGES=CONNECTION_CONSTS.ERROR_MESSAGES);_export('MAX_SAMPLE_COUNT',MAX_SAMPLE_COUNT=NETCRUNCH_TREND_DATA_CONST.MAX_SAMPLE_COUNT);NET_CRUNCH_API_SERVICE_DI=['adrem','alertSrv','backendSrv','$rootScope'];NetCrunchAPIService=function(){function NetCrunchAPIService(a,b,c,d){_classCallCheck(this,NetCrunchAPIService),this.adrem=a,this.alertSrv=b,this.backendSrv=c,this.$rootScope=d,this.cache=new NetCrunchConnectionCache}return _createClass(NetCrunchAPIService,[{key:'testConnection',value:function testConnection(a){var _this=this;return this.clearConnection(a).then(function(){return _this.getConnection(a,!0)}).then(function(){return _this.clearConnection(a)})}},{key:'clearConnection',value:function clearConnection(a){var b=this;return new Promise(function(c){b.cache.connectionExist(a)?b.cache.getConnection(a).then(function(d){d.logout().then(function(){b.cache.deleteConnection(a),c()})}):c()})}},{key:'getConnection',value:function getConnection(a){function c(g){return new Promise(function(h,i){f.backendSrv.get(g.apiURL+'api.json').then(function(j){h(j)}).catch(function(j){j.isHandled=!0,i(CONNECTION_CONSTS.ERROR_SERVER_API)})})}function d(g,h){return h.onError=function(i){f.alertSrv.set(i.connectionName,i.message,'error')},h.onNodesChanged=function(){f.$rootScope.$broadcast('netcrunch-nodes-data-changed('+g.name+')')},h.onNetworksChanged=function(){f.$rootScope.$broadcast('netcrunch-networks-data-changed('+g.name+')')},h}function e(g,h){return new Promise(function(i,j){h.login(g.username,g.password,b).then(function(){h.fromCache=!1,i(h)}).catch(function(k){f.cache.deleteConnection(g),h.logout(),j(k)})})}var b=1<arguments.length&&void 0!==arguments[1]&&arguments[1],f=this;if(!this.cache.connectionExist(a)){var g=new NetCrunchConnection(this.adrem,a.url,a.name);return c(g).then(function(h){return new Promise(function(i,j){var k=NetCrunchConnection.checkApiVersion(h);0===k.status?i(k.version):j(k.status)})}).then(function(){return g=d(a,g),f.cache.addConnection(a,e(a,g)),f.cache.getConnection(a)})}return function(h){return f.cache.getConnection(h).then(function(i){return i.fromCache=!0,i})}(a)}}]),NetCrunchAPIService}();NetCrunchAPIService.$inject=NET_CRUNCH_API_SERVICE_DI;_export('CONNECTION_ERROR_MESSAGES',CONNECTION_ERROR_MESSAGES);_export('MAX_SAMPLE_COUNT',MAX_SAMPLE_COUNT);angular.module(servicesModule).service('netCrunchAPIService',NetCrunchAPIService)}}});
//# sourceMappingURL=netCrunchAPI.service.js.map
