'use strict';System.register(['./networkData/networkData','./countersData','./trendData'],function(_export,_context){'use strict';var NetCrunchNetworkData,NetCrunchCountersData,NetCrunchTrendData,NETCRUNCH_TREND_DATA_CONST,_createClass,CONNECTION_CONSTS,NetCrunchConnection;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}return{setters:[function(_networkDataNetworkData){NetCrunchNetworkData=_networkDataNetworkData.NetCrunchNetworkData},function(_countersData){NetCrunchCountersData=_countersData.NetCrunchCountersData},function(_trendData){NetCrunchTrendData=_trendData.NetCrunchTrendData;NETCRUNCH_TREND_DATA_CONST=_trendData.NETCRUNCH_TREND_DATA_CONST}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();_export('CONNECTION_CONSTS',CONNECTION_CONSTS={API_NAME:'/ncapi/',NC_SERVER_VER_MAJOR:9,NC_SERVER_VER_MINOR:3,STATUS_OK:0,ERROR_SERVER_API:1,ERROR_SERVER_VER:2,ERROR_CONNECTION_INIT:3,ERROR_AUTHENTICATION:4,ERROR_MESSAGES:['','Server connection failed','NetCrunch server version should be 9.3 or greater','Server connection initialization failed','Authentication failed']});_export('NetCrunchConnection',NetCrunchConnection=function(){function NetCrunchConnection(a,b,c){var _this=this;_classCallCheck(this,NetCrunchConnection),this.adrem=a,this.apiName=CONNECTION_CONSTS.API_NAME,this.apiURL=b+this.apiName,this.connectionName=c,this.serverConnection=null,this.serverConnectionReady=null,this.netCrunchClient=null,this.trendQuery=null,this.loginInProgress=!1,this.loginInProgressPromise=null,this.networkAtlas=new Map,this.networkAtlasReady=new Promise(function(d){_this.networkAtlasReadyResolve=d}),this.counters=new Map,this.trends=null}return _createClass(NetCrunchConnection,[{key:'login',value:function login(a,b){var _this2=this,c=2<arguments.length&&void 0!==arguments[2]&&arguments[2];function d(){'function'==typeof this.onNodesChanged&&this.onNodesChanged()}function f(){'function'==typeof this.onNetworksChanged&&this.onNetworksChanged()}return null==this.serverConnection&&(this.serverConnectionReady=this.establishConnection()),this.serverConnectionReady.then(function(){return _this2.authenticateUser(a,b).then(function(){return _this2.networkAtlas=new NetCrunchNetworkData(_this2.adremClient,_this2.serverConnection),_this2.networkAtlas.onNodesChanged=d.bind(_this2),_this2.networkAtlas.onNetworksChanged=f.bind(_this2),_this2.counters=new NetCrunchCountersData(_this2.adremClient,_this2.serverConnection),_this2.trends=new NetCrunchTrendData(_this2),!0!==c&&_this2.networkAtlas.init().then(function(){_this2.networkAtlasReadyResolve(_this2.networkAtlas)}),!0})})}},{key:'logout',value:function logout(){var a=this;return new Promise(function(b){null==a.serverConnectionReady?b():a.serverConnectionReady.then(function(){a.netCrunchClient.logout(function(){b()})}).catch(function(){b()})})}},{key:'establishConnection',value:function establishConnection(){var a=this;return new Promise(function(b,c){a.adrem.then(function(d){var f=a.apiName,g=a.apiURL;a.adremClient=d,a.serverConnection=new d.Connection(g),a.serverConnection.useWebSocket=!1,a.serverConnection.reloadOnLogout=!1,a.netCrunchClient=a.serverConnection.Client,a.netCrunchClient.urlFilter=function(h){return g+h.replace(f,'')},a.netCrunchClient.on('exception',function(h){'function'==typeof a.onError&&a.onError({connectionName:a.connectionName,message:h.message})}),a.netCrunchClient.start('',function(h){!0===h.init?b():c(CONNECTION_CONSTS.ERROR_CONNECTION_INIT)})})})}},{key:'authenticateUser',value:function authenticateUser(a,b){var _this3=this,f=3,g=this.netCrunchClient,h=void 0;function c(i){return 5e3*(f-i+1)}function d(i,j,k){// eslint-disable-line
return new Promise(function(l,m){g.login(i,j,function(n){!0===n?l():1<k?setTimeout(function(){d(i,j,k-1).then(function(){l()}).catch(function(){m()})},c(k)):m()})})}return!1===this.loggedIn()?!1===this.loginInProgress?function(){var i=_this3;_this3.loginInProgress=!0,h=new Promise(function(j,k){d(a,b,f).then(function(){i.loginInProgress=!1,i.loginInProgressPromise=null,j()}).catch(function(){i.loginInProgress=!1,i.loginInProgressPromise=null,k(CONNECTION_CONSTS.ERROR_AUTHENTICATION)})}),_this3.loginInProgressPromise=h}():h=this.loginInProgressPromise:h=Promise.resolve(),h}},{key:'loggedIn',value:function loggedIn(){return null!=this.netCrunchClient&&'Session'in this.netCrunchClient&&!0===this.netCrunchClient.status.logged}},{key:'queryTrendData',value:function queryTrendData(){return null==this.trendQuery&&(this.trendQuery=new this.serverConnection.ncSrv.ITrendQuery),this.callApi(this.trendQuery.AnalyzeGetData,arguments);// eslint-disable-line
}},{key:'callApi',value:function callApi(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:!0,d=this;return new Promise(function(f,g){b=Array.prototype.slice.call(b,0),a.apply(d,b.concat([function(h){void 0!==h||c?f(h):g()}]))})}}],[{key:'checkApiVersion',value:function checkApiVersion(a){function b(f){var g=/^(\d+).(\d+).(\d+)(.(\d+))*$/,h=g.exec(f);return null==h?null:{major:h[1],minor:h[2],bugfix:h[3],text:f}}function c(f,g,h){var i=!1;return parseInt(f.major,10)>=parseInt(g,10)&&(parseInt(f.major,10)>parseInt(g,10)?i=!0:parseInt(f.minor,10)>=parseInt(h,10)&&(i=!0)),i}function d(f){var g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return{status:f,version:g}}if(null!=a.api&&null!=a.api[0]&&null!=a.api[0].ver){var f=CONNECTION_CONSTS.NC_SERVER_VER_MAJOR,g=CONNECTION_CONSTS.NC_SERVER_VER_MINOR,h=b(a.api[0].ver);return null==h?d(CONNECTION_CONSTS.ERROR_SERVER_VER):c(h,f,g)?d(CONNECTION_CONSTS.STATUS_OK,h):d(CONNECTION_CONSTS.ERROR_SERVER_VER,h)}return d(CONNECTION_CONSTS.ERROR_SERVER_VER)}}]),NetCrunchConnection}());_export('CONNECTION_CONSTS',CONNECTION_CONSTS);_export('NETCRUNCH_TREND_DATA_CONST',NETCRUNCH_TREND_DATA_CONST);_export('NetCrunchConnection',NetCrunchConnection)}}});
//# sourceMappingURL=connection.js.map
