{"version":3,"sources":["../../../../src/datasource/services/netCrunchAPI/netCrunchAPI.service.js"],"names":["angular","servicesModule","NetCrunchConnectionCache","NetCrunchConnection","CONNECTION_CONSTS","NETCRUNCH_TREND_DATA_CONST","CONNECTION_ERROR_MESSAGES","ERROR_MESSAGES","MAX_SAMPLE_COUNT","NET_CRUNCH_API_SERVICE_DI","NetCrunchAPIService","adrem","alertSrv","backendSrv","$rootScope","cache","datasource","clearConnection","then","getConnection","self","Promise","resolve","connectionExist","connection","logout","deleteConnection","getServerApi","reject","get","apiURL","api","catch","error","isHandled","ERROR_SERVER_API","addConnectionHandlers","onError","set","connectionName","message","onNodesChanged","$broadcast","name","onNetworksChanged","createSession","login","username","password","withoutNetworkAtlas","fromCache","url","checkStatus","checkApiVersion","serverApi","status","version","addConnection","$inject","module","service"],"mappings":"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","file":"netCrunchAPI.service.js","sourcesContent":["/**\n * @license\n * Copyright AdRem Software. All Rights Reserved.\n *\n * Use of this source code is governed by an Apache License, Version 2.0 that can be\n * found in the LICENSE file.\n */\n\n/* eslint-disable no-shadow, no-param-reassign */\n\nimport angular from 'angular';\nimport { servicesModule } from '../../common';\nimport './adrem/module';\nimport { NetCrunchConnectionCache } from './connectionCache';\nimport { NetCrunchConnection, CONNECTION_CONSTS, NETCRUNCH_TREND_DATA_CONST } from './netCrunchConnection/connection';\n\nconst\n  CONNECTION_ERROR_MESSAGES = CONNECTION_CONSTS.ERROR_MESSAGES,\n  MAX_SAMPLE_COUNT = NETCRUNCH_TREND_DATA_CONST.MAX_SAMPLE_COUNT,\n  NET_CRUNCH_API_SERVICE_DI = ['adrem', 'alertSrv', 'backendSrv', '$rootScope'];\n\nclass NetCrunchAPIService {\n\n  constructor(adrem, alertSrv, backendSrv, $rootScope) {\n    this.adrem = adrem;\n    this.alertSrv = alertSrv;\n    this.backendSrv = backendSrv;\n    this.$rootScope = $rootScope;\n    this.cache = new NetCrunchConnectionCache();\n  }\n\n  testConnection(datasource) {\n    return this.clearConnection(datasource)\n      .then(() => this.getConnection(datasource, true))\n      .then(() => this.clearConnection(datasource));\n  }\n\n  clearConnection(datasource) {\n    const self = this;\n    return new Promise((resolve) => {\n      if (self.cache.connectionExist(datasource)) {\n        self.cache.getConnection(datasource)\n          .then((connection) => {\n            connection.logout()\n              .then(() => {\n                self.cache.deleteConnection(datasource);\n                resolve();\n              });\n          });\n      } else {\n        resolve();\n      }\n    });\n  }\n\n  getConnection(datasource, withoutNetworkAtlas = false) {\n    const self = this;\n\n    function getConnectionFromCache(datasource) {\n      return self.cache.getConnection(datasource)\n        .then((connection) => {\n          connection.fromCache = true;\n          return connection;\n        });\n    }\n\n    function getServerApi(connection) {\n      return new Promise((resolve, reject) => {\n        self.backendSrv.get(`${connection.apiURL}api.json`)\n          .then((api) => {\n            resolve(api);\n          })\n          .catch((error) => {\n            error.isHandled = true;\n            reject(CONNECTION_CONSTS.ERROR_SERVER_API);\n          });\n      });\n    }\n\n    function addConnectionHandlers(datasource, connection) {\n\n      connection.onError = (error) => {\n        self.alertSrv.set(error.connectionName, error.message, 'error');\n      };\n\n      connection.onNodesChanged = () => {\n        self.$rootScope.$broadcast(`netcrunch-nodes-data-changed(${datasource.name})`);\n      };\n\n      connection.onNetworksChanged = () => {\n        self.$rootScope.$broadcast(`netcrunch-networks-data-changed(${datasource.name})`);\n      };\n\n      return connection;\n    }\n\n    function createSession(datasource, connection) {\n      return new Promise((resolve, reject) => {\n        connection.login(datasource.username, datasource.password, withoutNetworkAtlas)\n          .then(() => {\n            connection.fromCache = false;\n            resolve(connection);\n          })\n          .catch((error) => {\n            self.cache.deleteConnection(datasource);\n            connection.logout();\n            reject(error);\n          });\n      });\n    }\n\n    if (!this.cache.connectionExist(datasource)) {\n      let connection = new NetCrunchConnection(this.adrem, datasource.url, datasource.name);\n\n      return getServerApi(connection)\n        .then(serverApi =>\n          new Promise((resolve, reject) => {\n            const checkStatus = NetCrunchConnection.checkApiVersion(serverApi);\n            if (checkStatus.status === 0) {\n              resolve(checkStatus.version);\n            } else {\n              reject(checkStatus.status);\n            }\n          })\n        )\n        .then(() => {\n          connection = addConnectionHandlers(datasource, connection);\n          self.cache.addConnection(datasource, createSession(datasource, connection));\n          return self.cache.getConnection(datasource);\n        });\n    }\n    return getConnectionFromCache(datasource);\n  }\n\n}\n\nNetCrunchAPIService.$inject = NET_CRUNCH_API_SERVICE_DI;\n\nexport {\n  CONNECTION_ERROR_MESSAGES,\n  MAX_SAMPLE_COUNT\n};\n\nangular\n  .module(servicesModule)\n    .service('netCrunchAPIService', NetCrunchAPIService);\n"]}