/* AdRem Client.js v4.2.7 2016 Copyright Tomasz Kunicki, AdRem Software, all rights reserved */
(function(global,factory){"use strict";var url;if(typeof define==="function"&&define.amd){url=decodeURIComponent(global.location.pathname);define("client",["jquery"],function(jQuery){return factory(global,jQuery,url,false)})}else{if(global.location!==undefined){url=decodeURIComponent(global.location.pathname)}else{url=""}return factory(global,global.jQuery,url,global.global!==undefined)}})(typeof window==="undefined"?global:window,function(global,jQuery,locationUrl,isNodeJS){"use strict";var adrem=global.adrem||{},$=jQuery,httpRequest,httpURL;adrem.isEmbedded=global.__SendRequest!==undefined&&typeof global.__SendRequest==="function";adrem.isNodeJS=isNodeJS;adrem.isJQuery=global.jQuery!==undefined||$!==undefined&&$.zepto!==undefined;adrem.pageUrl=locationUrl;adrem.useWebSockets=!adrem.isEmbedded&&global.WebSocket!=null;adrem.traceLocaRequest=false;adrem.reloadOnLogout=true;if(isNodeJS){httpRequest=require("request");httpURL=require("url")}function isArgumentsAsObject(arg){return typeof arg==="object"&&(typeof arg.params==="object"||typeof arg.callback==="function")}function isArray(obj){return obj.constructor===Array}function toJSON(obj){return JSON.stringify(obj)}function fromJSON(s){return JSON.parse(s)}function isPlainObject(obj){if(jQuery.type(obj)!=="object"||obj.nodeType||jQuery.isWindow(obj)){return false}if(obj.constructor&&!hasOwnProperty.call(obj.constructor.prototype,"isPrototypeOf")){return false}return true}adrem.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&typeof target!=="function"){target={}}if(length===i){target=this;--i}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=adrem.extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target};function findObj(namespace,root){var path=namespace.split("."),i,obj=root||global,prop;for(i=0;i<path.length;i+=1){prop=path[i];if(obj[prop]===undefined){obj[prop]={}}obj=obj[prop]}return obj}function embeddedRequestHandler(client,request,handler){if(adrem.traceLocaRequest){console.group("--> Request "+request.url);console.log(request);console.groupEnd()}global.__SendRequest(request.url,request.intf,request.method,toJSON(request.data),function(status,response){var data;if(adrem.traceLocaRequest){console.group("<-- Response "+request.url);if(response!=null){data=fromJSON(response)}if(isArray(data)){console.table(data)}else{console.log(data)}console.groupEnd()}handler({responseText:response||""},status)})}function ajaxRequestHandler(client,request,callback){var url=client.urlPrefix+request.url,method=request.method!==undefined?request.intf+"."+request.method:undefined,sid=client.sid===""||client.sid===undefined?"":"sid="+client.sid;if(request.url.indexOf("?")===-1){sid="?"+sid}else{sid="&"+sid}function extJSRequest(request,callback){global.Ext.Ajax.request({url:request.url+sid,method:request.data===null?"GET":"POST",params:{method:method},timeout:request.timeout||15*1e3,jsonData:request.data,success:function(response){callback(response,true)},failure:function(response){if(response.status===449&&client.connection.reloadOnLogout){global.location.href=adrem.pageUrl}callback(response,true)}})}function jQueryRequest(request,callback){var url=request.url+sid+(method!==undefined?"&method="+method:"");if(client.urlFilter!=null&&typeof client.urlFilter==="function"){url=client.urlFilter(url)||url}global.$.ajax({url:url,type:request.data===undefined||request.data===null?"GET":"POST",contentType:"application/json",data:toJSON(request.data),timeout:request.timeout||15*1e3,cache:false,complete:function(response,success){if(success==="error"&&response.status===449){if(client.connection.reloadOnLogout){global.location.href=client.connection.pageUrl}}else{callback(response,success==="success")}}})}function nodeJSRequest(request,callback){var path,requestParts=request.url.split("?"),queryString={};if(request.url[0]!=="/"){url=client.connection.pageUrl+requestParts[0]}else{path=httpURL.parse(client.connection.pageUrl);path.pathname=requestParts[0];url=httpURL.format(path)}if(sid==="?"){sid=undefined}else{sid=client.sid}if(sid!==undefined){queryString.sid=sid}if(method!==undefined&&method!==""){queryString.method=method}if(requestParts.length>1){requestParts[1].split("&").forEach(function(p){var v=p.split("=");queryString[v[0]]=v[1]})}if(client.urlFilter!=null&&typeof client.urlFilter==="function"){url=client.urlFilter(url)||url}httpRequest(url,{method:request.data===undefined||request.data===null?"GET":"POST",timeout:request.timeout||15*1e3,qs:queryString,gzip:true,json:request.data,strictSSL:false},function(err,response,body){client.lastError=undefined;if(response!=null&&response.statusCode===200){if(typeof body!=="string"){body=toJSON(body)}callback({responseText:body},true)}else{client.lastError=err;callback({},false)}})}if(adrem.isJQuery){jQueryRequest(request,callback)}else if(adrem.isNodeJS){nodeJSRequest(request,callback)}else if(global.Ext!=null){extJSRequest(request,callback)}else{console.error("No xhr library found");throw"No xhr library found"}}function AdremLocalProvider(requestHandler,connection){var requests=[];this.connection=connection||adrem;function getRequest(){if(requests.length>0&&!requests.pending){return requests.shift()}else{return null}}function handleRequest(request){if(request!==null){requests.pending=true;requestHandler(connection.Client,request,function(rq){return function(response,success){requests.pending=false;if(requests.length>0){handleRequest(getRequest())}rq.callback(rq,response,success)}}(request))}}if(adrem.isEmbedded&&connection===adrem){global.__dispatchEvents=function(events){try{if(!Array.isArray(events)){connection.Client.fireEvent(events.name.toLowerCase(),events)}else{events.forEach(function(ev){connection.Client.fireEvent(ev.name.toLowerCase(),ev)})}}catch(e){console.error(e.stack)}}}this.isProcessing=function(){return requests.pending};this.request=function(request){request.queue=true;if(!adrem.isEmbedded&&requests.pending){requests.push(request)}else{handleRequest(request)}};requests.pending=false}function AdremRemoteProvider(requestHandler,retentionTime,connection){var tid=1,aTime=retentionTime||25,me=this,requests=[],apiGroups=[],timerId=null;this.connection=connection||adrem;function scheduleTasks(aTask){if(timerId==null){timerId=setTimeout(function(){timerId=null;aTask()},aTime)}}function doProcessRequests(url,requests,onFinished){var i,data=[],r;data=requests.map(function(rq){rq.tid=tid;tid+=1;return{action:rq.intf,method:rq.method,data:rq.data,type:"rpc",tid:rq.tid}});requestHandler(connection.Client,{url:url,data:data,scope:me},function(pendingRequests){return function(response,success){var id,i,baseTid,rq,responses;if(success){baseTid=pendingRequests[0].tid;responses=fromJSON(response.responseText);if(!isArray(responses)){responses=[responses]}for(i=0;i<responses.length;i+=1){id=responses[i].tid;rq=pendingRequests[id-baseTid];rq.callback(rq,{response:responses[i]},success)}}else{for(i=0;i<pendingRequests.length;i+=1){rq=pendingRequests[i];rq.callback(rq,{responseText:response.responseText,statusText:response.statusText},success)}}onFinished()}}(requests))}function processRequests(){apiGroups.forEach(function(g){var list=g.requests;if(!g.pending&&g.requests.length>0){g.requests=[];doProcessRequests(g.url,list,function(){g.pending=false;if(g.requests.length>0){processRequests()}})}})}function groupRequest(rq){var group=apiGroups.find(function(g){return g.url===rq.url});if(group==null){group={url:rq.url,pending:false,requests:[]};apiGroups.push(group)}group.requests.push(rq)}this.request=function(request){groupRequest(request);scheduleTasks(processRequests)}}function AdremPollingProvider(api,aRequestHandler,client){var requestHandler=aRequestHandler,me=this,pollingTime=api.interval||50,errorPollingTime=60*1e3;this.dispatchEvents=function(response,success){var reply,i,len;if(success&&response.responseText!==""){reply=fromJSON(response.responseText);if(isArray(reply)){for(i=0,len=reply.length;i<len;i+=1){if(reply[i].name!==undefined&&client.hasListener(reply[i].name.toLowerCase())){client.fireEvent(reply[i].name.toLowerCase(),reply[i])}}}else if(reply.name!==undefined&&client.hasListener(reply.name.toLowerCase())){client.fireEvent(reply.name.toLowerCase(),reply)}if(!client.connection.webSocketsMode()){global.setTimeout(pollEvents,pollingTime)}}else{if(!client.connection.webSocketsMode()){global.setTimeout(pollEvents,errorPollingTime)}}};function pollEvents(){requestHandler(client,{url:me.api.url,timeout:me.api.timeout||6e4,scope:me},function(response,success){me.dispatchEvents(response,success)})}me.api=api;if(!client.connection.webSocketsMode()){global.setTimeout(function(){if(!client.connection.webSocketsMode()){pollEvents()}},500)}}function AdremWebSocketProvider(ajaxProvider){var socket,lastTid=1,pending={},url,i,client=ajaxProvider.connection.Client||adrem.Client;this.useWebSocket=function(){var wsProtocol=location.protocol.toUpperCase()==="HTTPS:"?"wss://":"ws://";if(client.connection.useWebSockets){if(client===undefined||client.sid===undefined||client.sid===0){console.log("Can't create websocket - no SID ",client);client.connection.socket=undefined;socket=undefined;return false}else{try{url=locationUrl;i=url.length-1;while(url[i]!=="/"&&i>0){i--}if(url[i]==="/"){url=url.substr(0,i+1)}socket=new WebSocket(wsProtocol+client.connection.$host+url+client.sid);socket.onerror=function(){console.log("WebSocket error, falling back to AJAX RPC!");client.connection.useWebSockets=false;client.connection.socket=undefined;socket=undefined};socket.onclose=function(){client.fireEvent("connection-closed");socket=undefined};socket.onmessage=function(ev){var msgparts=ev.data.split(""),prefix,data,response,request;prefix=msgparts[0];data=msgparts[1];if(prefix==="e"){client.connection.api.events.provider.dispatchEvents({responseText:data},true)}else if(prefix==="r"){response=fromJSON(data);request=pending[response.tid];delete pending[response.tid];request.callback(request,{response:response},true)}else{console.log("Invalid message prefix");socket.close();socket=undefined;client.fireEvent("connection-closed")}};return true}catch(e){console.log("Error opening websocket ",e);client.connection.useWebSockets=false;client.connection.socket=undefined;socket=undefined;return false}}}return client.connection.useWebSockets};client.connection.webSocketsMode=function(){return client.connection.useWebSockets&&socket!==undefined&&socket.readyState===socket.OPEN};this.request=function(request){var api=request.url.split("=")[1],rq;if(client.connection.useWebSockets&&client.connection.webSocketsMode()){lastTid+=1;pending[lastTid]=request;rq={dat:request.data,call:request.intf+"."+request.method,tid:lastTid};socket.send(api+""+toJSON(rq))}else{ajaxProvider.request(request)}}}function EventManager(){var events={};this.fireEvent=function(eventId){var args=Array.prototype.slice.call(arguments,1);eventId=eventId.toLowerCase();if(events.hasOwnProperty(eventId)){events[eventId].forEach(function(listener){listener.fn.apply(listener.scope,args)},this)}};this.on=function(eventId,fn,scope){if(isArray(eventId)){eventId.forEach(function(e){this.on(e,fn,scope)},this)}else{eventId=eventId.toLowerCase();if(events[eventId]===undefined){events[eventId]=[]}events[eventId].push({fn:fn,scope:scope})}};this.un=function(eventId,fn,scope){var listeners,i;if(isArray(eventId)){eventId.forEach(function(e){this.un(e,fn,scope)},this)}else{eventId=eventId.toLowerCase();if(events[eventId]){listeners=events[eventId];for(i=listeners.length-1;i>=0;i-=1){if(listeners[i].fn===fn&&listeners[i].scope===scope){events[eventId].splice(i,1)}}}}};this.hasListener=function(eventId){return events!==undefined&&(events[eventId]&&events[eventId].length>0)}}function RemoteClient(hostAddr,applicationId,connection){var _asyncId=1,that=this,remoteProvider,appId="",tokenId;RemoteClient.inherited.constructor.apply(this);this.status={logged:false};this.connection=connection;this.connection.Client=this;function removeRemoteObject(obj){var id=obj.id.split(".")[1],owner=findObj(obj.namespace,connection);if(owner[id]!==undefined){obj["@destroy"]();delete owner[id]}}function createRemoteObject(apiObj,actionName,instanceId){var cfg={namespace:[apiObj.name,actionName,"__inst__",instanceId].join("."),type:apiObj.type,url:apiObj.url,id:actionName+"$"+instanceId,actions:{},api:apiObj},instanceName=cfg.id,instance;cfg.actions[instanceName]=apiObj.actions[actionName];that.addAPI(cfg);instance=findObj(cfg.namespace,connection)[instanceName];instance.id=apiObj.name+"."+cfg.id;instance.namespace=cfg.namespace;instance.destroy=function(){removeRemoteObject(this)};return instance}function asURL(objAPI,method){var params=Array.prototype.slice.call(arguments,2);return objAPI.dataUrl+"?method="+objAPI.name+"."+method.action+"."+method.method+"&params="+encodeURIComponent(toJSON(params))+"&sid="+that.sid}function asTask(objAPI,method,params){var request=new(findObj(objAPI.namespace,connection).IObjAsyncCallTask),args,updateTime,callback,scope,fn,checkStatus=function(){request.finished=false;request.GetStatus(function(result){var p;for(p in result){if(result.hasOwnProperty(p)){request[p]=result[p]}}if(request.finished){that.fireEvent(request.id,{eventid:0,data:request.reply},request)}else{request.callback.call(request.scope,request);request.progressTask=global.setTimeout(checkStatus,updateTime)}},request)};if(isArgumentsAsObject(params)){args=params.params;updateTime=params.updateTime;callback=params.callback;scope=params.scope}else{args=Array.prototype.slice.call(arguments,3,3+method.len);updateTime=arguments[2];callback=arguments[2+method.len+1];scope=arguments[2+method.len+2]}request.Call(method.action,method.method,args,scope);request.callback=callback;request.scope=scope!==undefined?scope:request;request.progress=0;request.destroy=function(){that.fireEvent(request.id,{eventid:0},request)};that.on(request.id,fn=function(e){if(request.progressTask!==undefined){global.clearTimeout(request.progressTask)}if(request.callback!==undefined){request.finished=true;request.reply=e.data;request.callback.call(request.scope,request)}that.un(request.id,fn);request["@destroy"]()});if(updateTime>0&&callback!==undefined){request.progressTask=global.setTimeout(checkStatus,updateTime)}return request}function bindClientCalls(me,api){var i,len,actions=api.actions,intf,new_cls,fn,ms,m,cls,aapi;function globalEventsEventId(id){return api.name+"#"+id.toString(16)}function NewObject(intface,initParam){var obj,ix,objId;initParam=initParam||null;if(arguments[2]===undefined||typeof arguments[2]==="function"||typeof arguments[2]==="object"){objId=_asyncId;_asyncId+=1;ix=2}else{ix=3;objId=arguments[2]}obj=createRemoteObject.call(me,api,intface,objId);if(initParam!==null){if(arguments.length>ix){obj["@create"].apply(this,Array.prototype.concat(initParam,Array.prototype.slice.call(arguments,ix)))}else{obj["@create"](initParam)}}return obj}for(intf in actions){if(actions.hasOwnProperty(intf)){cls=findObj(api.namespace+"."+intf,connection);if(intf==="IGlobalEvents"){cls.eventId=globalEventsEventId}else if(intf!=="IClientServices"&&intf!=="Security"){if(cls.id===undefined){cls.id=api.name+"."+intf}if(cls.id.indexOf("$")<0){new_cls=NewObject.bind(that,intf);ms=actions[intf];for(i=0,len=ms.length;i<len;i+=1){m=ms[i];new_cls[m.name]=cls[m.name]}new_cls.id=cls.id;findObj(api.namespace,connection)[intf]=new_cls;cls=new_cls}ms=actions[intf];aapi=api.api!==undefined?api.api:api;for(i=0,len=ms.length;i<len;i+=1){fn=cls[ms[i].name];fn.asTask=asTask.bind(cls,aapi,fn);fn.asURL=asURL.bind(cls,aapi,fn)}}}}return api}function getRequestHandler(){return adrem.isEmbedded?embeddedRequestHandler:ajaxRequestHandler}if(!adrem.isEmbedded){remoteProvider=new AdremRemoteProvider(getRequestHandler(),25,connection)}else{remoteProvider=new AdremLocalProvider(getRequestHandler(),connection)}remoteProvider=new AdremWebSocketProvider(remoteProvider);appId=applicationId||"app";if(appId.split(".")[1]!==undefined){appId=""}else{appId=":"+appId}appId=hostAddr+appId;tokenId="tid:"+appId;this.start=function(){var ix=0,urlParts,scope,callback,self=this,requestHandler=getRequestHandler(this),sidItem="sid:"+appId;function doNotify(status){if(callback!==undefined){callback.call(scope,status)}self.status=status;if(self.connection.useWebSockets){remoteProvider.useWebSocket()}self.fireEvent("clientstarted",status);if(status.logged){self.fireEvent("login",status)}}this.urlPrefix="";this.appPrefix="";function splitURL(url){var appParts=url.split("/"),urlParts=appParts.splice(0,3);return{urlPrefix:urlParts.join("/")+"/",appPrefix:appParts.join("/")}}if(arguments.length>0){if(typeof arguments[ix]==="string"){urlParts=splitURL(arguments[ix]);this.urlPrefix=urlParts.urlPrefix;this.appPrefix=urlParts.appPrefix;ix+=1}if(ix<arguments.length&&typeof arguments[ix]==="function"){callback=arguments[ix];ix+=1;if(ix<arguments.length&&typeof arguments[ix]==="object"){scope=arguments[ix]}}}else{scope=global}if(global.sessionStorage!=null&&window.self===window.top){that.sid=global.sessionStorage.getItem(sidItem);if(that.sid===null){delete that.sid}}requestHandler(this,{url:this.appPrefix+"api.json"},function(response,success){var aToken,data;if(success){data=fromJSON(response.responseText);data.api.forEach(function(api){api.namespace=api.name;api.url=api.url.replace("//","/");if(api.dataUrl!=null){api.dataUrl=api.dataUrl.replace("//","/")}that.addAPI(api)});that.sid=data.sid;that.authentication=data.authentication;that.loggedIn=false;if(global.sessionStorage!==undefined){global.sessionStorage.setItem(sidItem,that.sid)}if("Session"in that){aToken=global.localStorage!==undefined?global.localStorage.getItem(tokenId):undefined;if(aToken!==undefined&&aToken!==null){that.Session.Security.Authenticate(aToken,function(result){if(!result.Success){global.localStorage.removeItem(tokenId)}else{global.localStorage.setItem(tokenId,result.Token)}that.loggedIn=result.Success;doNotify({logged:result.Success,init:true})})}else{doNotify({logged:false,init:true})}}else{that.loggedIn=true;doNotify({logged:true,init:true})}}else{doNotify({logged:false,init:false})}});return false};this.logout=function(callback,scope){if("Session"in that){that.Session.Security.Logout(function(){global.localStorage.removeItem(tokenId);if(callback!==undefined){callback.call(scope)}that.fireEvent("logout")})}else{throw new Error("No login support")}};this.login=function(aName,aPassword,callback,scope){function getPassword(pass){if(that.authentication==="plain"){return pass}else{console.error("only plain authetication supported");return pass}}if("Session"in that){that.Session.Security.Login(aName,getPassword(aPassword),function(result){if(result.Success){if(global.localStorage!==undefined){global.localStorage.setItem(tokenId,result.Token)}that.loggedIn=true}if(typeof callback==="function"){callback.call(scope,result.Success)}that.fireEvent("login",{logged:result.Success,init:true})})}else{throw new Error("No login support")}};this.addAPI=function(api){var apiDef;if(api.api==null){if(connection.api===undefined){connection.api={}}if(connection.api[api.name]!==undefined){return}connection.api[api.name]=api;if(api.namespace!=null){findObj(api.namespace,connection)}}else{api.name=api.api.name}if(api.type==="remoting"){api.provider=remoteProvider;apiDef=new RemoteAPI(api,this)}else if(api.type==="polling"){api.provider=new AdremPollingProvider(api,getRequestHandler(this),that)}if(api.type==="remoting"){bindClientCalls(apiDef,api)}return apiDef}}function RemoteAPI(api,client){var o=api.actions,c,cls,m,ms,fn,i,len;this.url=api.url;this.namespace=findObj(api.namespace,client.connection);function handleRemoteResponse(request,result,success){var reply,ev,method=request.intf+"."+request.method,callback=request.handler,errorHandler=request.errorHandler,scope=request.scope;function handledByCaller(param){return errorHandler!==undefined&&errorHandler(param)===true}if(success&&result&&(result.response!==undefined||result.responseText!=="")){reply=result.response!==undefined?result.response:fromJSON(result.responseText);if(reply.type==="exception"){if(!handledByCaller(reply.result)){ev=reply.result;ev.method=method;client.fireEvent("exception",ev)}return}}else if(success){reply={result:{success:false}}}if(!success){ev={classname:"xhr",method:method,message:"error calling: "+method};if(!handledByCaller(ev)){client.fireEvent("exception",ev)}}else if(callback!==undefined&&callback.call!==undefined){if(typeof callback==="function"){callback.call(scope,reply.result)}}}this.remoteCall=function(intf,method){var data,handler,errorHandler,scope,ix,args=Array.prototype.slice.call(arguments,2),url=this.url;if(args[0]!==null&&isArgumentsAsObject(args[0])){data=args[0].params;handler=args[0].callback;scope=args[0].scope;errorHandler=args[0].errorHandler}else{data=null;ix=method.len;if(ix===0){data=undefined}handler=args[ix];ix+=1;if(args[ix]!==undefined&&typeof args[ix]==="function"){errorHandler=args[ix];ix+=1}scope=args[ix];if(method.len!==0){data=args.slice(0,method.len)}}if(handler!==undefined&&handler.call===undefined){throw new Error("Invalid parameters passed")}api.provider.request({url:url,intf:intf,method:method.name,data:data,handler:handler,errorHandler:errorHandler,scope:scope,callback:handleRemoteResponse},true)};for(c in o){if(o.hasOwnProperty(c)){cls=findObj(api.namespace+"."+c,client.connection);cls.id=api.name+"."+c;ms=o[c];for(i=0,len=ms.length;i<len;i+=1){m=ms[i];fn=this.remoteCall.bind(this,c,m);fn.action=c;fn.len=m.len;fn.method=m.name;cls[m.name]=fn}}}}adrem.inherit=function(){var F=function(){};return function(C,P){F.prototype=P.prototype;C.prototype=new F;C.inherited=P.prototype;C.prototype.constructor=C}}();adrem.EventManager=EventManager;adrem.inherit(RemoteClient,adrem.EventManager);adrem.initClient=function(aHost,aAppId,connection){connection=connection||adrem;if(connection!==adrem){connection.useWebSocket=global.WebSocket!=null}connection.pageUrl=aHost;connection.$host=aHost;connection.reloadOnLogout=adrem.reloadOnLogout;connection.Client=new RemoteClient(aHost,aAppId,connection);connection.Client.isEmbedded=adrem.isEmbedded;connection.Client.sid="";return connection};function Connection(aHost,aAppId){return adrem.initClient(aHost,aAppId,this)}adrem.Connection=Connection;if(!isNodeJS){adrem.initClient(location.host,location.pathname.split("/")[1],adrem)}else{if(typeof module==="object"){module.exports.adrem=adrem}}if(adrem.isEmbedded){adrem.DispatchRequest=function(obj,result){obj.callback(obj,true,result)}}global.adrem=adrem;return adrem});