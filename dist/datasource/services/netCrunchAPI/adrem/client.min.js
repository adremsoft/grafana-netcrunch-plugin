/* AdRem Client.js v5.06 2018 Copyright Tomasz Kunicki, AdRem Software, all rights reserved */
!function(e,n){"use strict";var t;if("function"!=typeof define||!define.amd)return t=void 0!==e.location?decodeURIComponent(e.location.pathname):"",n(e,e.jQuery,t,void 0!==e.global);t=decodeURIComponent(e.location.pathname),define("client",["jquery"],function(o){return n(e,o,t,!1)})}("undefined"==typeof window?global:window,function(e,n,t,o){"use strict";var i,r,s,c=e.adrem||{},a=n;function l(e){return"object"==typeof e&&("object"==typeof e.params||"function"==typeof e.callback)}function u(e){return e.constructor===Array}function d(e){return JSON.stringify(e)}function p(e){return JSON.parse(e)}function f(e){if(null!=n){if("object"!==n.type(e)||e.nodeType||n.isWindow(e))return!1}else if("object"!=typeof e||e.nodeType)return!1;return!(e.constructor&&!hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))}function h(n,t){var o,i,r=n.split("."),s=t||e;for(o=0;o<r.length;o+=1)void 0===s[i=r[o]]&&(s[i]={}),s=s[i];return s}function v(n,t,o){function i(e){console.group?console.group(e):console.log(e)}function r(){console.groupEnd&&console.groupEnd()}c.traceLocaRequest&&(i("--\x3e Request "+t.url),console.log(t),r()),e.__SendRequest(t.url,t.intf,t.method,d(t.data),function(e,n){var s;c.traceLocaRequest&&(i("<-- Response "+t.url),null!=n&&(s="string"==typeof n?p(n):n),u(s)&&null!=console.table?console.table(s):console.log(s),r()),o("string"==typeof n?{responseText:n||""}:{response:n},e)})}function m(n,t,o){var s,a,l,u,p,f,h,v,m,g,y=n.urlPrefix+t.url,b=void 0!==t.method?t.intf+"."+t.method:void 0,S=""===n.sid||void 0===n.sid?"":"sid="+n.sid;if(S=-1===t.url.indexOf("?")?"?"+S:"&"+S,c.isJQuery)m=o,g=(v=t).url+S+(void 0!==b?"&method="+b:""),null!=n.urlFilter&&"function"==typeof n.urlFilter&&(g=n.urlFilter(g)||g),e.$.ajax({url:g,type:void 0===v.data||null===v.data?"GET":"POST",contentType:"application/json",data:d(v.data),timeout:v.timeout||15e3,cache:!1,complete:function(t,o){"error"===o&&449===t.status?n.connection.reloadOnLogout&&(e.location.href=n.connection.pageUrl):m(t,"success"===o)}});else if(c.isNodeJS)u=o,f=(l=t).url.split("?"),h={},"/"!==l.url[0]?y=n.connection.pageUrl+f[0]:((p=r.parse(n.connection.pageUrl)).pathname=f[0],y=r.format(p)),void 0!==(S="?"===S?void 0:n.sid)&&(h.sid=S),void 0!==b&&""!==b&&(h.method=b),f.length>1&&f[1].split("&").forEach(function(e){var n=e.split("=");h[n[0]]=n[1]}),null!=n.urlFilter&&"function"==typeof n.urlFilter&&(y=n.urlFilter(y)||y),i(y,{method:void 0===l.data||null===l.data?"GET":"POST",timeout:l.timeout||15e3,qs:h,gzip:!0,json:l.data,strictSSL:!1},function(e,t,o){n.lastError=void 0,null!=t&&200===t.statusCode?("string"!=typeof o&&(o=d(o)),u({responseText:o},!0)):(n.lastError=e,u({},!1))});else{if(null==e.Ext)throw console.error("No xhr library found"),"No xhr library found";s=t,a=o,e.Ext.Ajax.request({url:s.url+S,method:null===s.data?"GET":"POST",params:{method:b},timeout:s.timeout||15e3,jsonData:s.data,success:function(e){a(e,!0)},failure:function(t){449===t.status&&n.connection.reloadOnLogout&&(e.location.href=c.pageUrl),a(t,!0)}})}}function g(n,t){var o=[];function i(e){var r;null!==e&&(o.pending=!0,n(t.Client,e,(r=e,function(e,n){o.pending=!1,o.length>0&&i(o.length>0&&!o.pending?o.shift():null),r.callback(r,e,n)})))}this.connection=t||c,c.isEmbedded&&t===c&&(e.__dispatchEvents=function(e){try{Array.isArray(e)?e.forEach(function(e){t.Client.fireEvent(e.name.toLowerCase(),e)}):t.Client.fireEvent(e.name.toLowerCase(),e)}catch(e){console.error(e.stack)}}),this.isProcessing=function(){return o.pending},this.request=function(e){e.queue=!0,!c.isEmbedded&&o.pending?o.push(e):i(e)},o.pending=!1}function y(n,t,o){var i=1,r=t||25,s=this,a=[],l=null;function d(){a.forEach(function(e){var t,r,c,a,l,f=e.requests;!e.pending&&e.requests.length>0&&(e.requests=[],t=e.url,c=function(){e.pending=!1,e.requests.length>0&&d()},a=(r=f).map(function(e){return e.tid=i,i+=1,{action:e.intf,method:e.method,data:e.data,type:"rpc",tid:e.tid}}),n(o.Client,{url:t,data:a,scope:s},(l=r,function(e,n){var t,o,i,r,s;if(n)for(i=l[0].tid,u(s=p(e.responseText))||(s=[s]),o=0;o<s.length;o+=1)t=s[o].tid,(r=l[t-i]).callback(r,{response:s[o]},n);else for(o=0;o<l.length;o+=1)(r=l[o]).callback(r,{responseText:e.responseText,statusText:e.statusText},n);c()})))})}this.connection=o||c,this.request=function(n){var t,o,i;t=n,null==(o=a.find(function(e){return e.url===t.url}))&&(o={url:t.url,pending:!1,requests:[]},a.push(o)),o.requests.push(t),i=d,null==l&&(l=e.setTimeout(function(){l=null,i()},r))}}function b(n,o,i){var r,s,a=1,f=this,S="";function E(e,n,t){var o,r={namespace:[e.name,n,"__inst__",t].join("."),type:e.type,url:e.url,id:n+"$"+t,actions:{},api:e},s=r.id;return r.actions[s]=e.actions[n],f.addAPI(r),(o=h(r.namespace,i)[s]).id=e.name+"."+r.id,o.namespace=r.namespace,o.destroy=function(){var e,n,t;n=(e=this).id.split(".")[1],void 0!==(t=h(e.namespace,i))[n]&&(e["@destroy"](),delete t[n])},o}function k(e,n){var t=Array.prototype.slice.call(arguments,2);return e.dataUrl+"?method="+e.name+"."+n.action+"."+n.method+"&params="+encodeURIComponent(d(t))+"&sid="+f.sid}function w(n,t,o){var r,s,c,a,u,d=new(h(n.namespace,i).IObjAsyncCallTask),p=function(){d.finished=!1,d.GetStatus(function(n){var t;for(t in n)n.hasOwnProperty(t)&&(d[t]=n[t]);d.finished?f.fireEvent(d.id,{eventid:0,data:d.reply},d):(d.callback.call(d.scope,d),d.progressTask=e.setTimeout(p,s))},d)};return l(o)?(r=o.params,s=o.updateTime,c=o.callback,a=o.scope):(r=Array.prototype.slice.call(arguments,3,3+t.len),s=arguments[2],c=arguments[2+t.len+1],a=arguments[2+t.len+2]),d.Call(t.action,t.method,r,a),d.callback=c,d.scope=void 0!==a?a:d,d.progress=0,d.cancel=function(){d.finished||null==d.progressTask||(d.finished=!0,e.clearTimeout(d.progressTask),d.progressTask=null)},d.destroy=function(){f.fireEvent(d.id,{eventid:0},d)},f.on(d.id,u=function(n){void 0!==d.progressTask&&e.clearTimeout(d.progressTask),void 0!==d.callback&&(d.finished=!0,Object.keys(n.data).forEach(function(e){d[e]=n.data[e]}),d.callback.call(d.scope,d)),f.un(d.id,u),d["@destroy"]()}),s>0&&void 0!==c&&(d.progressTask=e.setTimeout(p,s)),d}function T(){return c.isEmbedded?v:m}b.inherited.constructor.apply(this),this.status={logged:!1},this.connection=i,this.connection.Client=this,r=new function(e){var n,o,i,r=1,s={},a=e.connection.Client||c.Client;this.useWebSocket=function(){var e="HTTPS:"===location.protocol.toUpperCase()?"wss://":"ws://";if(a.connection.useWebSockets){if(void 0===a||void 0===a.sid||0===a.sid)return console.log("Can't create websocket - no SID ",a),a.connection.socket=void 0,n=void 0,!1;try{for(i=(o=t).length-1;"/"!==o[i]&&i>0;)i--;return"/"===o[i]&&(o=o.substr(0,i+1)),(n=new WebSocket(e+a.connection.$host+o+a.sid)).onerror=function(){console.log("WebSocket error, falling back to AJAX RPC!"),a.connection.useWebSockets=!1,a.connection.socket=void 0,n=void 0},n.onclose=function(){a.fireEvent("connection-closed"),n=void 0},n.onmessage=function(e){var t,o,i,r,c=e.data.split("");t=c[0],o=c[1],"e"===t?a.connection.api.events.provider.dispatchEvents({responseText:o},!0):"r"===t?(i=p(o),r=s[i.tid],delete s[i.tid],r.callback(r,{response:i},!0)):(console.log("Invalid message prefix"),n.close(),n=void 0,a.fireEvent("connection-closed"))},!0}catch(e){return console.log("Error opening websocket ",e),a.connection.useWebSockets=!1,a.connection.socket=void 0,n=void 0,!1}}return a.connection.useWebSockets},a.connection.webSocketsMode=function(){return a.connection.useWebSockets&&void 0!==n&&n.readyState===n.OPEN},this.request=function(t){var o,i=t.url.split("=")[1];a.connection.useWebSockets&&a.connection.webSocketsMode()?(s[r+=1]=t,o={dat:t.data,call:t.intf+"."+t.method,tid:r},n.send(i+""+d(o))):e.request(t)}}(r=c.isEmbedded?new g(T(),i):new y(T(),25,i)),S=void 0!==(S=o||"app").split(".")[1]?"":":"+S,s="tid:"+(S=n+S),this.start=function(){var n,t,o,i,c,a,l=0,u=this,d=T(),h="sid:"+S;function v(e){void 0!==o&&o.call(t,e),u.status=e,u.connection.useWebSockets&&r.useWebSocket(),u.fireEvent("clientstarted",e),e.logged&&u.fireEvent("login",e)}return this.urlPrefix="",this.appPrefix="",arguments.length>0?("string"==typeof arguments[l]&&(c=arguments[l],n={urlPrefix:(a=c.split("/")).splice(0,3).join("/")+"/",appPrefix:a.join("/")},this.urlPrefix=n.urlPrefix,this.appPrefix=n.appPrefix,l+=1),l<arguments.length&&"function"==typeof arguments[l]&&(o=arguments[l],(l+=1)<arguments.length&&"object"==typeof arguments[l]&&(t=arguments[l]))):t=e,null!=e.sessionStorage&&null!=(i=e.sessionStorage.getItem(h))&&(f.sid=i),d(this,{url:this.appPrefix+"api.json"},function(n,t){var o,i;t?((i=n.response||p(n.responseText)).api.forEach(function(e){e.namespace=e.name,e.url=e.url.replace("//","/"),null!=e.dataUrl&&(e.dataUrl=e.dataUrl.replace("//","/")),f.addAPI(e)}),f.sid=i.sid,f.authentication=i.authentication,f.loggedIn=!1,void 0!==e.sessionStorage&&e.sessionStorage.setItem(h,f.sid),"Session"in f?void 0!==(o=void 0!==e.localStorage?e.localStorage.getItem(s):void 0)&&null!==o?f.Session.Security.Authenticate(o,function(n){n.Success?e.localStorage.setItem(s,n.Token):e.localStorage.removeItem(s),f.loggedIn=n.Success,v({logged:n.Success,init:!0})}):v({logged:!1,init:!0}):(f.loggedIn=!0,v({logged:!0,init:!0}))):v({logged:!1,init:!1})}),!1},this.logout=function(n,t){if(!("Session"in f))throw new Error("No login support");f.Session.Security.Logout(function(){e.localStorage.removeItem(s),void 0!==n&&n.call(t),f.fireEvent("logout")})},this.login=function(n,t,o,i){if(!("Session"in f))throw new Error("No login support");var r;f.Session.Security.Login(n,(r=t,"plain"===f.authentication?r:(console.error("only plain authetication supported"),r)),function(n){n.Success&&(void 0!==e.localStorage&&e.localStorage.setItem(s,n.Token),f.loggedIn=!0),"function"==typeof o&&o.call(i,n.Success),f.fireEvent("login",{logged:n.Success,init:!0})})},this.addAPI=function(n){var t;if(null==n.api){if(void 0===i.api&&(i.api={}),void 0!==i.api[n.name])return;i.api[n.name]=n,null!=n.namespace&&h(n.namespace,i)}else n.name=n.api.name;return"remoting"===n.type?(n.provider=r,t=new function(e,n){var t,o,i,r,s,c,a,u=e.actions;function d(e,t,o){var i,r,s=e.intf+"."+e.method,c=e.handler,a=e.errorHandler,l=e.scope;function u(e){return void 0!==a&&!0===a(e)}if(o&&t&&(void 0!==t.response||""!==t.responseText)){if("exception"===(i=void 0!==t.response?t.response:p(t.responseText)).type)return void(u(i.result)||((r=i.result).method=s,n.fireEvent("exception",r)))}else o&&(i={result:{success:!1}});o?void 0!==c&&void 0!==c.call&&"function"==typeof c&&c.call(l,i.result):u(r={classname:"xhr",method:s,message:"error calling: "+s})||n.fireEvent("exception",r)}this.url=e.url,this.namespace=h(e.namespace,n.connection),this.remoteCall=function(n,t){var o,i,r,s,c,a=Array.prototype.slice.call(arguments,2),u=this.url;if(null!==a[0]&&l(a[0])?(o=a[0].params,i=a[0].callback,s=a[0].scope,r=a[0].errorHandler):(o=null,0===(c=t.len)&&(o=void 0),i=a[c],void 0!==a[c+=1]&&"function"==typeof a[c]&&(r=a[c],c+=1),s=a[c],0!==t.len&&(o=a.slice(0,t.len))),void 0!==i&&void 0===i.call)throw new Error("Invalid parameters passed");e.provider.request({url:u,intf:n,method:t.name,data:o,handler:i,errorHandler:r,scope:s,callback:d},!0)};for(t in u)if(u.hasOwnProperty(t))for((o=h(e.namespace+"."+t,n.connection)).id=e.name+"."+t,r=u[t],c=0,a=r.length;c<a;c+=1)i=r[c],(s=this.remoteCall.bind(this,t,i)).action=t,s.len=i.len,s.method=i.name,o[i.name]=s}(n,this)):"polling"===n.type&&(n.provider=new function(n,t,o){var i=t,r=this,s=n.interval||50;function c(){i(o,{url:r.api.url,timeout:r.api.timeout||6e4,scope:r},function(e,n){r.dispatchEvents(e,n)})}this.dispatchEvents=function(n,t){var i,r,a;if(t&&""!==n.responseText){if(u(i=p(n.responseText)))for(r=0,a=i.length;r<a;r+=1)void 0!==i[r].name&&o.hasListener(i[r].name.toLowerCase())&&o.fireEvent(i[r].name.toLowerCase(),i[r]);else void 0!==i.name&&o.hasListener(i.name.toLowerCase())&&o.fireEvent(i.name.toLowerCase(),i);o.connection.webSocketsMode()||e.setTimeout(c,s)}else o.connection.webSocketsMode()||e.setTimeout(c,6e4)},r.api=n,o.connection.webSocketsMode()||e.setTimeout(function(){o.connection.webSocketsMode()||c()},500)}(n,T(),f)),"remoting"===n.type&&function(e,n){var t,o,r,s,c,l,u,d,p,v=n.actions;function m(e){return n.name+"#"+e.toString(16)}function g(t,o){var i,r,s;return o=o||null,void 0===arguments[2]||"function"==typeof arguments[2]||"object"==typeof arguments[2]?(s=a,a+=1,r=2):(r=3,s=arguments[2]),i=E.call(e,n,t,s),null!==o&&(arguments.length>r?i["@create"].apply(this,Array.prototype.concat(o,Array.prototype.slice.call(arguments,r))):i["@create"](o)),i}for(r in v)if(v.hasOwnProperty(r))if(d=h(n.namespace+"."+r,i),"IGlobalEvents"===r)d.eventId=m;else if("IClientServices"!==r&&"Security"!==r){if(void 0===d.id&&(d.id=n.name+"."+r),d.id.indexOf("$")<0){for(s=g.bind(f,r),t=0,o=(l=v[r]).length;t<o;t+=1)s[(u=l[t]).name]=d[u.name];s.id=d.id,h(n.namespace,i)[r]=s,d=s}for(l=v[r],p=void 0!==n.api?n.api:n,t=0,o=l.length;t<o;t+=1)(c=d[l[t].name]).asTask=w.bind(d,p,c),c.asURL=k.bind(d,p,c)}}(t,n),t}}return c.isEmbedded=void 0!==e.__SendRequest&&"function"==typeof e.__SendRequest,c.isNodeJS=o,c.isJQuery=void 0!==e.jQuery||void 0!==a&&void 0!==a.zepto,c.pageUrl=t,c.useWebSockets=!c.isEmbedded&&null!=e.WebSocket,c.traceLocaRequest=!1,c.reloadOnLogout=!0,o&&(require("fs").existsSync(require("path").join(__dirname,"webapp.js"))?(require("./webapp.js"),c.isEmbedded=!0):(i=require("request"),r=require("url"))),c.extend=function(){var e,n,t,o,i,r,s=arguments[0]||{},a=1,l=arguments.length,d=!1;for("boolean"==typeof s&&(d=s,s=arguments[1]||{},a=2),"object"!=typeof s&&"function"!=typeof s&&(s={}),l===a&&(s=this,--a);a<l;a++)if(null!=(e=arguments[a]))for(n in e)t=s[n],s!==(o=e[n])&&(d&&o&&(f(o)||(i=u(o)))?(i?(i=!1,r=t&&u(t)?t:[]):r=t&&f(t)?t:{},s[n]=c.extend(d,r,o)):void 0!==o&&(s[n]=o));return s},c.inherit=(s=function(){},function(e,n){s.prototype=n.prototype,e.prototype=new s,e.inherited=n.prototype,e.prototype.constructor=e}),c.ModuleResources=function(){var e=document.getElementsByTagName("script"),n=e[e.length-1].src.split("/").slice(0,-1).join("/"),t=this;fetch(n+"/text.res.json").then(function(e){return e.json()}).then(function(e){return c.extend(t,e)})},c.EventManager=function(){var e={};this.fireEvent=function(n){var t=Array.prototype.slice.call(arguments,1);n=n.toLowerCase(),e.hasOwnProperty(n)&&e[n].forEach(function(e){e.fn.apply(e.scope,t)},this)},this.on=function(n,t,o){u(n)?n.forEach(function(e){this.on(e,t,o)},this):(n=n.toLowerCase(),void 0===e[n]&&(e[n]=[]),e[n].push({fn:t,scope:o}))},this.un=function(n,t,o){var i,r;if(u(n))n.forEach(function(e){this.un(e,t,o)},this);else if(n=n.toLowerCase(),e[n])for(r=(i=e[n]).length-1;r>=0;r-=1)i[r].fn===t&&i[r].scope===o&&e[n].splice(r,1)},this.hasListener=function(n){return void 0!==e&&e[n]&&e[n].length>0}},c.inherit(b,c.EventManager),c.initClient=function(n,t,o){return(o=o||c)!==c&&(o.useWebSocket=null!=e.WebSocket),o.pageUrl=n,o.$host=n,o.reloadOnLogout=c.reloadOnLogout,o.Client=new b(n,t,o),o.Client.isEmbedded=c.isEmbedded,o.Client.sid="",o},c.Connection=function(e,n){return c.initClient(e,n,this)},o?"object"==typeof module&&(module.exports.adrem=c):void 0!==e.location&&c.initClient(e.location.host,e.location.pathname.split("/")[1],c),c.isEmbedded&&(c.DispatchRequest=function(e,n){e.callback(e,!0,n)}),e.adrem=c,c});