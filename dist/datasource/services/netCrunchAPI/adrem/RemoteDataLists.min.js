/* RemoteDataLists v2.94 2018 Copyright Tomasz Kunicki, AdRem Software, all rights reserved */
(function(c,d){"use strict";"function"==typeof define&&define.amd?define("remoteDataLists",["client"],function(f){return d(f),f.RemoteDataListStore}):d(c.adrem)})("undefined"==typeof window?global:window,function(c){"use strict";(function(d){const j="debug",l="rec",n="obj",o=function(B){return Array.isArray(B)?B:[B]},q=function(B,C,D,E){function F(K,L){return C.owner.autoDecodeDates&&2===K&&"string"==typeof L?null==Date.create?new Date(L):Date.create(L):L}let G,H,I,J;if(B===j)C.fields.forEach(function(K,L){const M=D[K.FieldName];void 0!==M&&(E[L]=F(C.fields[L].FieldType,M))});else if("R"===D[0])for(G=C.fields.length,H=0;H<G;H++)E[H]=F(C.fields[H].FieldType,D[H+1]);else if("C"===D[0])for(G=D.length,H=1;H<G;)I=D[H++],J=D[H++],E[I]=F(C.fields[I].FieldType,J)},r=function(B,C,D){let E,F,G,H=C.keyIx;if(B===j)return D[C.key];if("R"===D[0])return D[H+1];for(E=D.length-1;0<E;)if(G=D[E--],F=D[E--],F===H)return G;return null},s=function(C,D){const E={};let F={},G=function(I){return function(){let J=F[I];return void 0===J&&(J=E[I]),J}},H=function(I){return function(J){F[I]=J,C.fireEvent("property-changed",{name:I,value:J})}};this.getChanges=function(){return F},this.clearChanges=function(){d.extend(E,F),F={}},this.getValues=function(){return E},this.update=function(I){for(let J of Object.keys(I))E[J]!==I[J]&&(E[J]=I[J],this.hasOwnProperty(J)||Object.defineProperty(this,J,{get:G(J),set:H(J),configurable:!0,enumerable:!0}),C.fireEvent("property-changed",{name:J,value:E[J]}));F={}},this.isChanged=function(){return 0<Object.keys(F).length},this.update(D)},t={_getByIx:function(B){const C=this._owner_._private_;return C.changes[B]===void 0?C.values[B]:C.changes[B]},_setByIx:function(B,C){const D=this._owner_._private_;D.changes[B]=C,this._owner_.touch(),D.model.notifyRecChanged(this._owner_)}},u=function(C){function D(F){return function(){return t._getByIx.call(this,F)}}function E(F){return function(G){return t._setByIx.call(this,F,G)}}C.fields.forEach(function(F,G){Object.defineProperty(this,F.FieldName,{set:E(G),get:D(G),configurable:!0,enumerable:!0})},this),this.getByIndex=function(F){return t._getByIx.call(this,F)}},w=function(B){const C=function(E){Object.defineProperty(this,"_owner_",{value:E,configurable:!0})};return C.prototype=new u(B),C},y=function(){function B(E,F){return E!==F&&!d.deepEqual(JSON.parse(E),JSON.parse(F))}const C="undefined"!=typeof window&&null!=window.angular?angular.toJson:JSON.stringify,D=function(F,G,H){let I,J,K,L;if(Object.defineProperty(this,"_private_",{value:{}}),K=this._private_,K.values=[],K.changes=[],K.refs=[],K.model=F,this.values=new F.DataListValues(this),this.local={},this.lid=F.owner.lid,F.owner.lid+=1,J=this._private_.model.fields,G===j)for(I=J.length-1;0<=I;I--)K.values[I]=H[J[I].FieldName],K.changes[I]=void 0;else if(G===n)for(I=J.length-1;0<=I;I--)K.values[I]=void 0,K.changes[I]=H[J[I].FieldName],I===this._private_.model.keyIx&&(K.values[I]=K.changes[I]);else if(G===l)for(I=J.length-1;0<=I;I--)K.values[I]=H._private_.values[I],K.changes[I]=H._private_.changes[I];else this.update(G,H);if(F.owner.objChangeDetection)for(I=J.length-1;0<=I;I--)void 0===K.changes[I]&&(L=K.values[I],"object"==typeof L&&K.refs.push({ix:I,val:C(L)}));K.key=K.values[this._private_.model.keyIx],void 0!==this.getKey()&&G!==n?(K.changed=K.model.getChangeStamp(),K.serverRev=K.changed):this.touch()};return d.extend(D.prototype,{getKey:function(){return this._private_.key},unlink:function(){Object.defineProperty(this,"_owner_",{value:void 0}),delete this.values},setKey:function(E){if(void 0===this._private_.key)this._private_.values[this._private_.model.keyIx]=E,this._private_.key=E;else throw new Error("Invalid attempt to change record key.")},hasKey:function(){return void 0!==this._private_.key},isChanged:function(E){let F,G;if(void 0===E&&(E=this._private_.serverRev||0),this._private_.model.owner.objChangeDetection&&0<this._private_.refs.length)for(F=this._private_.refs.length-1;0<=F;F-=1)G=this._private_.refs[F],void 0===this._private_.changes[G.ix]?B(G.val,C(this._private_.values[G.ix]))&&(this._private_.changes[G.ix]=this._private_.values[G.ix],this._private_.refs.splice(F,1),this.touch()):B(G.val,C(this._private_.changes[G.ix]))?this._private_.refs.splice(F,1):this._private_.changes[G.ix]=void 0;return this._private_.changed>E},getValues:function(){let F,G,H,E={};for(G=this._private_.model.fields,F=G.length-1;0<=F;F--)H=G[F].FieldName,E[H]=this.values[H];return E},getChanges:function(){let E={},F=this.getKey(),G=!1;return this._private_.model.fields.forEach(function(H,I){2!==H.FieldData.Attributes&&(void 0===this._private_.changes[I]?void 0===F&&(E[H.FieldName]=this._private_.values[I],G=!0):(E[H.FieldName]=this._private_.changes[I],G=!0))},this),G?(E[this._private_.model.key]=F,E):null},clearChanges:function(){if(this._private_.changed>this._private_.serverRev){for(let E=this._private_.changes.length-1;0<=E;E--)this._private_.changes[E]=void 0;this._private_.changed=this._private_.serverRev}},remove:function(){this._private_.model.owner.delByRec(this)},update:function(E,F){q(E,this._private_.model,F,this._private_.values),this.clearChanges(),this._private_.serverRev=this._private_.model.getChangeStamp(),this._private_.changed=this._private_.serverRev},touch:function(){this._private_.changed=this._private_.model.getChangeStamp()}}),D}(),z=function(){function B(C,D){d.extend(this,D),this.owner=C,this.keyIx=-1,this.changeRevision=0,this.DataListValues=new w(this),this.fields.some(function(E,F){return E.FieldName===this.key&&(this.keyIx=F,!0)},this)}return d.extend(B.prototype,{finalize:function(){delete this.DataListValues},newRecord:function(C,D){return new y(this,C,D)},getChangeStamp:function(){return this.changeRevision+=1,this.changeRevision},notifyRecChanged:function(C){this.owner.notifyChanged(C)}}),B}(),A=function(){function B(D){D.eventid===0?this.needsRefresh=!0:D.eventid===1?this.needsRefreshProperties=!0:D.eventid===2&&(this.fastRefresh=!1,this.doRefresh(D.data)),this.fastRefresh&&(this.fastRefresh=!1,this.refresh())}const C=function(E,F,G){function H(){(I.needsRefresh||I.needsRefreshProperties)&&I.refresh(),I.commitProperties(),K=0<J?setTimeout(H,J):null}const I=this;let K,J=null!=F&&"number"==typeof F?F:350;this.map={},this.data=[],this.deleted=[],this.needsRefresh=!1,this.fastRefresh=!1,this.needsRefreshProperties=!1,this.updating=0,this.suppressedChangedNotification=!1,this.propertyupdating=!1,this.dataEncoding=d.debug?j:"work",this.objChangeDetection=!1,this.autoDecodeDates=!1,this.lid=1,Object.defineProperty(this,J,{get(){return J},set(L){J=L,null==K?H():0>J&&(clearTimeout(K),K=null)}}),null==G&&"object"==typeof F&&(G=F),this.connection=G||d,this.properties={beginUpdate:function(){I.propertyupdating=!0},endUpdate:function(){I.propertyupdating=!1}},this.remoteData=new this.connection[E].IDataListStore({dataFormat:this.dataEncoding}),this.connection.Client.on(this.remoteData.id,B,this),C.inherited.constructor.call(this),0<=J&&H()};return d.inherit(C,d.EventManager),d.extend(C.prototype,{deleteProperties:function(){Object.keys(this.properties).forEach(function(D){delete this.properties[D]},this)},finalize:function(){this.connection.Client.un(this.remoteData.id,B,this),this.remoteData&&this.remoteData.destroy(),delete this.remoteData,this.deleteProperties(),void 0!==this.model&&(this.model.finalize(),delete this.model)},notifyChanged:function(D){0===this.updating?(void 0!==D&&this.fireEvent("record-changed",D),this.fireEvent("changed")):this.suppressedChangedNotification=!0},notifyDeleted:function(D){0===this.updating?(this.fireEvent("record-deleted",D),this.fireEvent("changed")):0>this.deleted.indexOf(D)&&this.suppressedDeletes.push(D)},perform:function(){return this.remoteData.perform.apply(this,Array.prototype.slice.call(arguments,0))},asyncPerform:function(){return this.remoteData.perform.asTask.apply(this,Array.prototype.slice.call(arguments,0))},beginUpdate:function(){0===this.updating&&(this.suppressedChangedNotification=!1,this.suppressedDeletes=[],null!=this.model&&(this.updateRevision=this.model.getChangeStamp()-1)),this.updating+=1},endUpdate:function(D){let E=[],F=[];this.updating-=1,0===this.updating&&(this.suppressedChangedNotification||!0===D)&&(this.hasListener("record-changed")&&(E=this.data.filter(function(G){return G.isChanged(this.updateRevision)},this)),this.hasListener("record-deleted")&&(F=this.deleted.filter(function(G){return G._private_.deleted>this.updateRevision},this),F=F.concat(this.suppressedDeletes),this.suppressedDeletes=[]),0<E.length?this.notifyChanged(E):this.notifyChanged(),0<F.length&&(this.notifyDeleted(F),F.forEach(function(G){void 0!==G.unlink&&G.unlink()}),F=[]))},destroy:function(){this.minRefreshTime=-1,this.close(),this.finalize()},close:function(D){D=null==D||D,void 0!==this.model&&(this.model.finalize(),delete this.model),D&&null!=this.remoteData&&this.remoteData.close(),this.deleteProperties(),this.data=[],this.map={}},open:function(D,E,F,G){E=E||"",this.close(!1),this.tableName=D,this.remoteData.open(D,E,function(H){null==H&&console.error("Can't open table: ",D),(null==H.model&&null!=H.key||null!=H.fields)&&(H={model:H}),null!=H.model&&null!=H.model.fields&&(this.model=new z(this,H.model)),G=G||this,null==H.data?(this.needsRefresh=!0,this.refresh(function(){void 0!==F&&F.call(G,this.data),this.fireEvent("open",this),this.notifyChanged()})):(void 0!==F&&F.call(G,this.data),this.needsRefresh=!1,this.doRefresh(H.data),this.fireEvent("open",this),this.notifyChanged()),null==H.properties?this.readProperties(!0):this.doUpdateProperties(H.properties)},this)},getValues:function(){return this.data.map(function(D){return D.getValues()},this)},getByKey:function(D){return this.map[D]},delByIndex:function(D,E){let F,G;if(D<this.data.length)for(G=D+E,G>=this.data.length&&(G=this.data.length-1),F=G;F>=D;F-=1)this.delByRec(this.data[F])},delByRec:function(D,E){let F;void 0===E&&(E=!1),void 0!==D&&(F=D.getKey(),null!=F&&delete this.map[F],this.data.splice(this.data.indexOf(D),1),void 0!=F&&!E&&(D._private_.deleted=this.model.getChangeStamp(),this.deleted.push(D)),this.notifyDeleted(D),this.notifyChanged())},delByKey:function(D){void 0!==D&&this.delByRec(this.map[D])},addRecord:function(D){return this.data.push(D),void 0!==D.getKey()&&(this.map[D.getKey()]=D),this.notifyChanged(D),D},getRecCopy:function(D){return this.model.newRecord(l,D)},add:function(D){return this.addRecord(this.model.newRecord(n,D))},clear:function(){this.revert(),this.remoteData.clear(function(){const D=this.data;this.data=[],this.map=[],this.deleted=[],0<D.length&&(this.notifyDeleted(D),this.notifyChanged()),this.fireEvent("clear",this)},this)},doUpdateProperties(D){D.forEach(function(E){this.properties.hasOwnProperty(E.group)?this.properties[E.group].update(E.properties):this.properties[E.group]=new s(this,E.properties),this.fireEvent("property-group-changed",E.group,this.properties[E.group])},this)},readProperties:function(D){D&&null!=this.remoteData&&(this.needsRefreshProperties=!1,this.remoteData.getProperties(function(E){this.doUpdateProperties(E)},this))},commitProperties:function(){let D,E,F=[];if(!1===this.propertyupdating){for(E in this.properties)this.properties.hasOwnProperty(E)&&(D=this.properties[E],void 0!==D.isChanged&&D.isChanged()&&(F.push({group:E,properties:D.getChanges()}),D.clearChanges()));0<F.length&&this.remoteData.setProperties(F)}},refresh:function(D){this.readProperties(this.needsRefreshProperties),this.needsRefresh?(this.needsRefresh=!1,null!=this.remoteData&&this.remoteData.refresh(function(E){this.doRefresh(E),void 0!==D&&D.call(this)},this)):this.fastRefresh=!0},internalDoRefresh:function(D){let E,F,I,J,K,L,M,G={},H=[];if(D.reload&&(this.data=[],this.map={}),0<this.deleted.length&&this.deleted.forEach(function(N,O){G[N.getKey()]=O},this),void 0!==D.updates&&null!=this.model)for(I=Array.isArray(D.updates)?D.updates:[D.updates],E=I.length-1;0<=E;E--)K=I[E],J=r(this.dataEncoding,this.model,K),L=this.map[J],void 0==L?(F=G[J],void 0==F?this.addRecord(this.model.newRecord(this.dataEncoding,K)):this.deleted[F].update(this.dataEncoding,K)):(L.update(this.dataEncoding,K),this.notifyChanged(L));if(void 0!==D.deletes)for(I=Array.isArray(D.deletes)?D.deletes:[D.deletes],E=I.length-1;0<=E;E--)J=I[E],M=this.map[J],void 0==M?(F=G[J],void 0!==F&&H.push(F)):this.delByRec(this.map[J],!0),0<H.length&&(H.sort(function(N,O){return O-N}),H.forEach(function(N){this.deleted.splice(N,1)},this))},doRefresh:function(D){if(D.success){this.beginUpdate(),null!=D.fields&&(this.model=new z(this,{key:D.key,fields:D.fields}));try{this.internalDoRefresh(D)}finally{this.endUpdate(!0),null!=D.markers&&o(D.markers).forEach(function(E){this.fireEvent("change-marker",E)},this)}}},getLocalChanges:function(){const D={changes:[]};return D.changedRecords=this.data.filter(function(E){let F;return!!E.isChanged()&&(F=E.getChanges(),null!=F&&(D.changes.push(F),!0))},this),D.deleted=this.deleted.map(function(E){return E.getKey()}),D},isChanged:function(){const D=this.getLocalChanges();return 0<D.changes.length+D.deleted.length},commit:function(D){const E=this.getLocalChanges();let F=!1,G=!1;this.deleted=[],0<E.deleted.length&&(this.remoteData.remove(E.deleted),F=!0),0<E.changes.length&&(F=!0,G=!0,this.remoteData.update(E.changes,function(H){H=o(H),E.changedRecords.forEach(function(I,J){J<H.length&&void 0===I.getKey()&&(I.setKey(H[J]),this.map[H[J]]=I)},this),null!=D&&"function"==typeof D&&D()},this)),F&&(this.fireEvent("commit",this),this.refresh()),!G&&F&&null!=D&&"function"==typeof D&&D()},revert:function(){for(let D=this.data.length-1;0<=D;D--)void 0===this.data[D].getKey()?this.data.splice(D,1):this.data[D].isChanged()&&this.data[D].clearChanges();this.deleted.forEach(function(D){D.isChanged()&&D.clearChanges(),this.addRecord(D)},this),this.deleted=[],this.fireEvent("revert",this),this.notifyChanged()}}),C}();d.deepEqual=function(){function B(I){return"[object Arguments]"===Object.prototype.toString.call(I)}function C(I,J,K){return K=K||{},I===J||(I instanceof Date&&J instanceof Date?I.getTime()===J.getTime():I&&J&&("object"==typeof I||"object"==typeof J)?F(I,J,K):K.strict?I===J:I==J)}function D(I){return null===I||I===void 0}function E(I){return I&&"object"==typeof I&&"number"==typeof I.length&&("function"!=typeof I.copy||"function"!=typeof I.slice?!1:!(0<I.length&&"number"!=typeof I[0]))}function F(I,J,K){let L,M,N,O;if(D(I)||D(J))return!1;if(I.prototype!==J.prototype)return!1;if(B(I))return!!B(J)&&(I=G.call(I),J=G.call(J),C(I,J,K));if(E(I)){if(!E(J))return!1;if(I.length!==J.length)return!1;for(L=0;L<I.length;L++)if(I[L]!==J[L])return!1;return!0}try{N=H(I),O=H(J)}catch(P){return!1}if(N.length!==O.length)return!1;for(N.sort(),O.sort(),L=N.length-1;0<=L;L--)if(N[L]!==O[L])return!1;for(L=N.length-1;0<=L;L--)if(M=N[L],!C(I[M],J[M],K))return!1;return typeof I==typeof J}const G=Array.prototype.slice,H=Object.keys;return C}(),d.RemoteDataListStore=A,"object"==typeof module&&(module.exports=A)})(c)});