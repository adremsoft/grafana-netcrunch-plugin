'use strict';System.register(['./services/netCrunchAPI/module','./templateQuery/metricFindQuery'],function(_export,_context){'use strict';var CONNECTION_ERROR_MESSAGES,MAX_SAMPLE_COUNT,NetCrunchMetricFindQuery,_createClass,PRIVATE_PROPERTIES,SERIES_TYPES_DISPLAY_NAMES,NET_CRUNCH_DATASOURCE_DI,NetCrunchDatasource;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}return{setters:[function(_servicesNetCrunchAPIModule){CONNECTION_ERROR_MESSAGES=_servicesNetCrunchAPIModule.CONNECTION_ERROR_MESSAGES;MAX_SAMPLE_COUNT=_servicesNetCrunchAPIModule.MAX_SAMPLE_COUNT},function(_templateQueryMetricFindQuery){NetCrunchMetricFindQuery=_templateQueryMetricFindQuery.NetCrunchMetricFindQuery}],execute:function(){_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();PRIVATE_PROPERTIES={netCrunchAPI:Symbol('netCrunchAPI'),netCrunchConnection:Symbol('netCrunchConnection'),atlas:Symbol('atlas'),nodes:Symbol('nodes'),processedNodes:Symbol('processedNodes'),alertSrv:Symbol('alertSrv'),templateSrv:Symbol('templateSrv')};SERIES_TYPES_DISPLAY_NAMES={min:'Min',avg:'Avg',max:'Max',avail:'Avail',delta:'Delta',equal:'Equal',distr:'Distr'};NET_CRUNCH_DATASOURCE_DI=['instanceSettings','netCrunchAPIService','alertSrv','templateSrv','$rootScope','$timeout'];_export('NetCrunchDatasource',NetCrunchDatasource=function(){function NetCrunchDatasource(a,b,c,d,e,f){function g(p,q){function r(){p.atlas().then(function(s){m(s.nodes),k.operations=s.nodes.operations,k.operations.asyncSortByNameAndAddress(s.nodes.getAllNodes()).then(function(t){k.all=t,n(k)})})}q&&r(),e.$on('netcrunch-nodes-data-changed('+j.name+')',r)}function h(p,q){function r(){p.atlas().then(function(s){return l(s)})}q&&r(),e.$on('netcrunch-networks-data-changed('+j.name+')',r)}function i(){return new Promise(function(p,q){var r=void 0;null==j.url?q(''):(r=j[PRIVATE_PROPERTIES.netCrunchAPI].getConnection(j),r.then(function(s){var t=s.fromCache;j[PRIVATE_PROPERTIES.netCrunchConnection]=s,g(s.networkAtlas,t),h(s.networkAtlas,t),p()}).catch(function(s){j[PRIVATE_PROPERTIES.alertSrv].set(j.name,CONNECTION_ERROR_MESSAGES[s],'error'),console.log(''),console.log('NetCrunch datasource'),console.log(j.name+': '+CONNECTION_ERROR_MESSAGES[s]),q(CONNECTION_ERROR_MESSAGES[s])}))})}_classCallCheck(this,NetCrunchDatasource);var j=this,k={},l=void 0,m=void 0,n=void 0,o=null;this[PRIVATE_PROPERTIES.netCrunchAPI]=b,this[PRIVATE_PROPERTIES.atlas]=new Promise(function(p){return l=p}),this[PRIVATE_PROPERTIES.nodes]=new Promise(function(p){return m=p}),this[PRIVATE_PROPERTIES.processedNodes]=new Promise(function(p){return n=p}),this[PRIVATE_PROPERTIES.alertSrv]=c,this[PRIVATE_PROPERTIES.templateSrv]=d,this.name=a.name,this.url=a.url,this.serverUrl=a.jsonData.simpleUrl,this.username=a.jsonData.user,this.password=a.jsonData.password,this.MAX_SAMPLE_COUNT=MAX_SAMPLE_COUNT,this.datasourceReady=function(){return null==o&&(o=i()),o},this.refreshView=function(){f(function(){null==e.$$phase&&e.$apply()},0)}}return _createClass(NetCrunchDatasource,[{key:'testDatasource',value:function testDatasource(){var _this=this;return new Promise(function(a){_this[PRIVATE_PROPERTIES.netCrunchAPI].testConnection(_this).then(function(){a({status:'success',message:'Datasource connected'}),_this.refreshView()}).catch(function(b){a({status:'error',message:CONNECTION_ERROR_MESSAGES[b]}),_this.refreshView()})})}},{key:'query',value:function query(a){function b(l,m){var n=k[PRIVATE_PROPERTIES.netCrunchConnection].counters,o=k.getNodeById(l).then(function(q){return null==q?null:q.name}),p=k.getCounters(l).then(function(q){var r=n.findCounterByName(q,m);return null==r?null:r.displayName});return Promise.all([o,p]).then(function(q){var r=q[0],// eslint-disable-line
s=q[1];// eslint-disable-line
return null!=r&&null!=s?{nodeName:r,counterDisplayName:s}:null})}function c(l){return Object.keys(l).some(function(m){return!0===l[m]})}function d(l,m,n){var o=n.nodeName+' - '+n.counterDisplayName;return null!=l&&(o=k.name+' - '+o),o=m||o,o}function e(l,m){return l+'\\'+SERIES_TYPES_DISPLAY_NAMES[m]}function f(l,m,n,o){var p=k[PRIVATE_PROPERTIES.netCrunchConnection].trends;return!1===c(o)?Promise.resolve([]):p.getCounterTrendData(l,m,n.from,n.to,n.periodType,n.periodInterval,o).then(function(q){// eslint-disable-line
return Object.keys(q.values).map(function(r){// eslint-disable-line
return{seriesType:r,dataPoints:{domain:q.domain,values:q.values[r]}}})})}function g(l,m,n){var o=k.decodeNodeIdTemplate(l.nodeID),p=null;return!0!==l.hide&&!0===l.counterDataComplete&&(p=b(o,l.counterName).then(function(q){var r=null,s=void 0,t=void 0,u=void 0;return null!=q&&(s=d(l.datasource,l.alias,q),r=[Promise.resolve(s)],u=null==n?Object.create(null):n,u=NetCrunchDatasource.validateSeriesTypes(u),t=f(o,l.counterName,m,u),r.push(t),r=Promise.all(r)),r})),p}function h(l,m,n){var o=[];return l.forEach(function(p){var q=!0===n?{avg:!0}:p.series,r=g(p,m,q);null!=r&&o.push(r)}),o}function i(l,m){var n=Object.create(null),o=k[PRIVATE_PROPERTIES.netCrunchConnection].trends;return n.data=[],null!=l&&0<l.length&&l.forEach(function(p){var q=null==p?null:p[0],r=null==p?null:p[1],s=void 0;null!=p&&r.forEach(function(t){s=!0==!m?e(q,t.seriesType):q,n.data.push({target:s,datapoints:o.grafanaDataConverter(t.dataPoints)})})}),n}function j(l){var m=k[PRIVATE_PROPERTIES.netCrunchConnection].trends,n=l.targets||[],o=function(v){return'string'==typeof v&&0<=v.toUpperCase().indexOf('RAW')}(l.maxDataPoints),p=function(v){var w=parseInt(v,10);return Number.isInteger(w)&&w>=MAX_SAMPLE_COUNT.MIN?Math.min(w,MAX_SAMPLE_COUNT.MAX):MAX_SAMPLE_COUNT.DEFAULT}(l.maxDataPoints),q=l.range.from.startOf('minute'),r=l.range.to.startOf('minute'),s=m.prepareTimeRange(q,r,o,p),t=[];if(null==s.error)t=t.concat(h(n,s.result,o));else{// eslint-disable-next-line
var u='Maximum allowed length of time range for RAW data is  '+s.error.periodInterval+' '+s.error.periodName+'.';k[PRIVATE_PROPERTIES.alertSrv].set('Time range is too long.',u,'warning')}return Promise.all(t).then(function(u){return i(u,o)})}var k=this;try{return this.datasourceReady().then(function(){return j(a)})}catch(l){return Promise.reject(l)}}},{key:'metricFindQuery',value:function metricFindQuery(a){var _this2=this;return this.datasourceReady().then(function(){return null==a?Promise.resolve([]):new NetCrunchMetricFindQuery(_this2,a).process()})}},{key:'atlas',value:function atlas(){var _this3=this;return this.datasourceReady().then(function(){return _this3[PRIVATE_PROPERTIES.atlas]})}},{key:'nodes',value:function nodes(){var _this4=this;return this.datasourceReady().then(function(){return _this4[PRIVATE_PROPERTIES.processedNodes]})}},{key:'getNodeVariables',value:function getNodeVariables(){var _this5=this;return this[PRIVATE_PROPERTIES.templateSrv].variables.filter(function(a){return _this5.decodeDatasourceNameTemplate(a.datasource)===_this5.name}).filter(function(a){return a.query.match(/^[nN][oO][dD][eE][sS].*/)})}},{key:'isNodeTemplate',value:function isNodeTemplate(a){return!Number.isInteger(a)&&0<=this.getNodeVariables().findIndex(function(b){return'$'+b.name===a})}},{key:'decodeDatasourceNameTemplate',value:function decodeDatasourceNameTemplate(a){return this[PRIVATE_PROPERTIES.templateSrv].replace(a)}},{key:'decodeNodeIdTemplate',value:function decodeNodeIdTemplate(a){if(Number.isInteger(a))return a;if(this.isNodeTemplate(a)){var b=this[PRIVATE_PROPERTIES.templateSrv].replace(a),c=+b;return Number.isInteger(c)?c:(c=b.match(/^{(.*)}$/),c=null!=c&&2===c.length?c[1].split(','):null,c=null!=c&&0<c.length?+c[0]:null,c)}return null}},{key:'getNodeById',value:function getNodeById(a){var _this6=this;return this.datasourceReady().then(function(){return _this6[PRIVATE_PROPERTIES.nodes]}).then(function(b){return b.getNodeById(_this6.decodeNodeIdTemplate(a))})}},{key:'getCounters',value:function getCounters(a){var _this7=this,b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0;return this.datasourceReady().then(function(){return _this7[PRIVATE_PROPERTIES.netCrunchConnection].counters.getCountersForMonitors(_this7.decodeNodeIdTemplate(a),b)})}}],[{key:'validateSeriesTypes',value:function validateSeriesTypes(a){var b=a||Object.create(null);return['min','avg','max','avail','delta','equal','distr'].forEach(function(c){b[c]=null!=b[c]&&b[c]}),b}}]),NetCrunchDatasource}());NetCrunchDatasource.$inject=NET_CRUNCH_DATASOURCE_DI;_export('NetCrunchDatasource',NetCrunchDatasource)}}});
//# sourceMappingURL=datasource.js.map
