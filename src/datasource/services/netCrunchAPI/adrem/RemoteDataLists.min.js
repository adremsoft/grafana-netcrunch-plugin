/* RemoteDataLists v2.9 2016 Copyright Tomasz Kunicki, AdRem Software, all rights reserved */
(function(global,factory){"use strict";if(typeof define==="function"&&define.amd){define("remoteDataLists",["client"],function(adrem){factory(adrem);return adrem.RemoteDataListStore})}else{factory(global.adrem)}})(typeof window==="undefined"?global:window,function(adrem){"use strict";(function(adrem){var E_DATA_CHANGED=0,E_PROPERTIES_CHANGED=1,E_DATA_CHANGED_WITH_DATA=2,ENC_DEBUG="debug",ENC_WORK="work",ENC_REC="rec",ENC_OBJ="obj",asArray=function(data){return Array.isArray(data)?data:[data]},decodeRecordData=function(encoding,model,data,values){var len,i,ix,val;function fixDateField(fieldType,val){if(model.owner.autoDecodeDates&&fieldType===2&&typeof val==="string"){if(Date.create!=null){return Date.create(val)}else{return new Date(val)}}return val}if(encoding===ENC_DEBUG){model.fields.forEach(function(field,i){var val=data[field.FieldName];if(val!==undefined){values[i]=fixDateField(model.fields[i].FieldType,val)}})}else{if(data[0]==="R"){len=model.fields.length;for(i=0;i<len;i++){values[i]=fixDateField(model.fields[i].FieldType,data[i+1])}}else if(data[0]==="C"){len=data.length;for(i=1;i<len;){ix=data[i++];val=data[i++];values[ix]=fixDateField(model.fields[ix].FieldType,val)}}}},decodeRecordKey=function(encoding,model,data){var i,ix,val,keyIx=model.keyIx;if(encoding===ENC_DEBUG){return data[model.key]}else{if(data[0]==="R"){return data[keyIx+1]}else{for(i=data.length-1;i>0;){val=data[i--];ix=data[i--];if(ix===keyIx){return val}}}}return null},DataListPropertyGroup=function DataListPropertyGroup(owner,cfg){var values={},changes={},_get=function(p){return function(){var v=changes[p];if(v===undefined){v=values[p]}return v}},_set=function(p){return function(val){changes[p]=val;owner.fireEvent("property-changed",{name:p,value:val})}};this.getChanges=function(){return changes};this.clearChanges=function(){adrem.extend(values,changes);changes={}};this.getValues=function(){return values};this.update=function(cfg){for(var p in cfg){if(cfg.hasOwnProperty(p)){if(values[p]!==cfg[p]){values[p]=cfg[p];if(!this.hasOwnProperty(p)){Object.defineProperty(this,p,{get:_get(p),set:_set(p),configurable:true,enumerable:true})}owner.fireEvent("property-changed",{name:p,value:values[p]})}}}changes={}};this.isChanged=function(){var p;for(p in changes){if(changes.hasOwnProperty(p)){return true}}return false};this.update(cfg)},localFieldAdapter={_getByIx:function(ix){var privateData=this._owner_._private_;return privateData.changes[ix]!==undefined?privateData.changes[ix]:privateData.values[ix]},_setByIx:function(ix,val){var privateData=this._owner_._private_;privateData.changes[ix]=val;this._owner_.touch();privateData.model.notifyRecChanged(this._owner_)}},DataListRecordFieldAdapter=function DataListRecordFieldAdapter(model){function _get(ix){return function(){return localFieldAdapter._getByIx.call(this,ix)}}function _set(ix){return function(value){return localFieldAdapter._setByIx.call(this,ix,value)}}model.fields.forEach(function(field,i){Object.defineProperty(this,field.FieldName,{set:_set(i),get:_get(i),configurable:true,enumerable:true})},this);this.getByIndex=function(ix){return localFieldAdapter._getByIx.call(this,ix)}},CreateDataListRecordValues=function(model){var Constructor=function DataListRecordValues(owner){Object.defineProperty(this,"_owner_",{value:owner,configurable:true})};Constructor.prototype=new DataListRecordFieldAdapter(model);return Constructor},DataListRecord=function(){var toJson=typeof window!=="undefined"&&window.angular!=null?angular.toJson:JSON.stringify;function isObjectChanged(jsonRef,jsonObj){if(jsonRef!==jsonObj){return!adrem.deepEqual(JSON.parse(jsonRef),JSON.parse(jsonObj))}else{return false}}var Constructor=function DataListRecord(model,encoding,cfg){var i,fields,_private,val;Object.defineProperty(this,"_private_",{value:{}});_private=this._private_;_private.values=[];_private.changes=[];_private.refs=[];_private.model=model;this.values=new model.DataListValues(this);this.local={};this.lid=model.owner.lid;model.owner.lid+=1;fields=this._private_.model.fields;if(encoding===ENC_DEBUG){for(i=fields.length-1;i>=0;i--){_private.values[i]=cfg[fields[i].FieldName];_private.changes[i]=undefined}}else if(encoding===ENC_OBJ){for(i=fields.length-1;i>=0;i--){_private.values[i]=undefined;_private.changes[i]=cfg[fields[i].FieldName];if(i===this._private_.model.keyIx){_private.values[i]=_private.changes[i]}}}else if(encoding===ENC_REC){for(i=fields.length-1;i>=0;i--){_private.values[i]=cfg._private_.values[i];_private.changes[i]=cfg._private_.changes[i]}}else{this.update(encoding,cfg)}if(model.owner.objChangeDetection){for(i=fields.length-1;i>=0;i--){if(_private.changes[i]===undefined){val=_private.values[i];if(typeof val==="object"){_private.refs.push({ix:i,val:toJson(val)})}}}}_private.key=_private.values[this._private_.model.keyIx];if(this.getKey()!==undefined&&encoding!==ENC_OBJ){_private.changed=_private.model.getChangeStamp();_private.serverRev=_private.changed}else{this.touch()}};adrem.extend(Constructor.prototype,{getKey:function(){return this._private_.key},unlink:function(){Object.defineProperty(this,"_owner_",{value:undefined});delete this.values},setKey:function(key){if(this._private_.key===undefined){this._private_.values[this._private_.model.keyIx]=key;this._private_.key=key}else{throw new Error("Invalid attempt to change record key.")}},hasKey:function(){return this._private_.key!==undefined},isChanged:function(since){var i,ref;if(since===undefined){since=this._private_.serverRev||0}if(this._private_.model.owner.objChangeDetection){if(this._private_.refs.length>0){for(i=this._private_.refs.length-1;i>=0;i-=1){ref=this._private_.refs[i];if(this._private_.changes[ref.ix]!==undefined){if(!isObjectChanged(ref.val,toJson(this._private_.changes[ref.ix]))){this._private_.changes[ref.ix]=undefined}else{this._private_.refs.splice(i,1)}}else{if(isObjectChanged(ref.val,toJson(this._private_.values[ref.ix]))){this._private_.changes[ref.ix]=this._private_.values[ref.ix];this._private_.refs.splice(i,1);this.touch()}}}}}return this._private_.changed>since},getValues:function(){var values={},i,fields,fname;fields=this._private_.model.fields;for(i=fields.length-1;i>=0;i--){fname=fields[i].FieldName;values[fname]=this.values[fname]}return values},getChanges:function(){var res={},key=this.getKey(),hasChanges=false;this._private_.model.fields.forEach(function(field,i){if(field.FieldData.Attributes!==2){if(this._private_.changes[i]!==undefined){res[field.FieldName]=this._private_.changes[i];hasChanges=true}else if(key===undefined){res[field.FieldName]=this._private_.values[i];hasChanges=true}}},this);if(hasChanges){res[this._private_.model.key]=key;return res}else{return null}},clearChanges:function(){var i;if(this._private_.changed>this._private_.serverRev){for(i=this._private_.changes.length-1;i>=0;i--){this._private_.changes[i]=undefined}this._private_.changed=this._private_.serverRev}},remove:function(){this._private_.model.owner.delByRec(this)},update:function(encoding,data){decodeRecordData(encoding,this._private_.model,data,this._private_.values);this.clearChanges();this._private_.serverRev=this._private_.model.getChangeStamp();this._private_.changed=this._private_.serverRev},touch:function(){this._private_.changed=this._private_.model.getChangeStamp()}});return Constructor}(),DataListModel=function(){function DataListModel(owner,data){adrem.extend(this,data);this.owner=owner;this.keyIx=-1;this.changeRevision=0;this.DataListValues=new CreateDataListRecordValues(this);this.fields.some(function(field,ix){if(field.FieldName===this.key){this.keyIx=ix;return true}else{return false}},this)}adrem.extend(DataListModel.prototype,{finalize:function(){delete this.DataListValues},newRecord:function(encoding,cfg){return new DataListRecord(this,encoding,cfg)},getChangeStamp:function(){this.changeRevision+=1;return this.changeRevision},notifyRecChanged:function(rec){this.owner.notifyChanged(rec)}});return DataListModel}(),RemoteDataListStore=function(){function onClientEvent(e){if(e.eventid===E_DATA_CHANGED){this.needsRefresh=true}else if(e.eventid===E_PROPERTIES_CHANGED){this.needsRefreshProperties=true}else if(e.eventid===E_DATA_CHANGED_WITH_DATA){this.fastRefresh=false;this.doRefresh(e.data)}if(this.fastRefresh){this.fastRefresh=false;this.refresh()}}var Constructor=function RemoteDataListStore(api,minRefreshTime,connection){var self=this;this.map={};this.data=[];this.deleted=[];this.minRefreshTime=minRefreshTime!=null&&typeof minRefreshTime==="number"?minRefreshTime:250;this.needsRefresh=false;this.fastRefresh=false;this.needsRefreshProperties=false;this.updating=0;this.suppressedChangedNotification=false;this.propertyupdating=false;this.dataEncoding=adrem.debug?ENC_DEBUG:ENC_WORK;this.objChangeDetection=false;this.autoDecodeDates=false;this.lid=1;if(connection==null&&typeof minRefreshTime==="object"){connection=minRefreshTime}this.connection=connection||adrem;this.properties={beginUpdate:function(){self.propertyupdating=true},endUpdate:function(){self.propertyupdating=false}};this.remoteData=new this.connection[api].IDataListStore({dataFormat:this.dataEncoding});this.connection.Client.on(this.remoteData.id,onClientEvent,this);function refreshData(){if(self.needsRefresh||self.needsRefreshProperties){self.refresh()}self.commitProperties();setTimeout(refreshData,self.minRefreshTime)}Constructor.inherited.constructor.call(this);refreshData()};adrem.inherit(Constructor,adrem.EventManager);adrem.extend(Constructor.prototype,{deleteProperties:function(){Object.keys(this.properties).forEach(function(key){delete this.properties[key]},this)},finalize:function(){this.connection.Client.un(this.remoteData.id,onClientEvent,this);if(this.remoteData){this.remoteData.destroy()}delete this.remoteData;this.deleteProperties();if(this.model!==undefined){this.model.finalize();delete this.model}},notifyChanged:function(data){if(this.updating===0){if(data!==undefined){this.fireEvent("record-changed",data)}this.fireEvent("changed")}else{this.suppressedChangedNotification=true}},notifyDeleted:function(data){if(this.updating===0){this.fireEvent("record-deleted",data);this.fireEvent("changed")}else{if(this.deleted.indexOf(data)<0){this.suppressedDeletes.push(data)}}},perform:function(){return this.remoteData.perform.apply(this,Array.prototype.slice.call(arguments,0))},asyncPerform:function(){return this.remoteData.perform.asTask.apply(this,Array.prototype.slice.call(arguments,0))},beginUpdate:function(){if(this.updating===0){this.suppressedChangedNotification=false;this.suppressedDeletes=[];if(this.model!=null){this.updateRevision=this.model.getChangeStamp()-1}}this.updating+=1},endUpdate:function(force){var changed=[],deleted=[];this.updating-=1;if(this.updating===0&&(this.suppressedChangedNotification||force===true)){if(this.hasListener("record-changed")){changed=this.data.filter(function(rec){return rec.isChanged(this.updateRevision)},this)}if(this.hasListener("record-deleted")){deleted=this.deleted.filter(function(rec){return rec._private_.deleted>this.updateRevision},this);deleted=deleted.concat(this.suppressedDeletes);this.suppressedDeletes=[]}if(changed.length>0){this.notifyChanged(changed)}else{this.notifyChanged()}if(deleted.length>0){this.notifyDeleted(deleted);deleted.forEach(function(rec){if(rec.unlink!==undefined){rec.unlink()}});deleted=[]}}},destroy:function(){this.close();this.finalize()},close:function(force){force=force!=null?force:true;if(this.model!==undefined){this.model.finalize();delete this.model}if(force&&this.remoteData!=null){this.remoteData.close()}this.deleteProperties();this.data=[];this.map={}},open:function(tableName,query,callback,scope){query=query||"";this.close(false);this.tableName=tableName;this.remoteData.open(tableName,query,function(model){if(model==null){console.error("Can't open table: ",tableName)}if(model!=null&&model.fields!=null){this.model=new DataListModel(this,model)}scope=scope||this;this.readProperties(true)},this);this.needsRefresh=true;this.refresh(function(){if(callback!==undefined){callback.call(scope,this.data)}this.fireEvent("open",this);this.notifyChanged()})},getValues:function(){return this.data.map(function(rec){return rec.getValues()},this)},getByKey:function(key){return this.map[key]},delByIndex:function(ix,count){var i,startix;if(ix<this.data.length){startix=ix+count;if(startix>=this.data.length){startix=this.data.length-1}for(i=startix;i>=ix;i-=1){this.delByRec(this.data[i])}}},delByRec:function(rec,permanent){var key;if(permanent===undefined){permanent=false}if(rec!==undefined){key=rec.getKey();if(key!=null){delete this.map[key]}this.data.splice(this.data.indexOf(rec),1);if(key!==undefined&&!permanent){rec._private_.deleted=this.model.getChangeStamp();this.deleted.push(rec)}this.notifyDeleted(rec);this.notifyChanged()}},delByKey:function(key){if(key!==undefined){this.delByRec(this.map[key])}},addRecord:function(rec){this.data.push(rec);if(rec.getKey()!==undefined){this.map[rec.getKey()]=rec}this.notifyChanged(rec);return rec},getRecCopy:function(rec){return this.model.newRecord(ENC_REC,rec)},add:function(cfg){return this.addRecord(this.model.newRecord(ENC_OBJ,cfg))},clear:function(){this.revert();this.remoteData.clear(function(){var deleted=this.data;this.data=[];this.map=[];this.deleted=[];if(deleted.length>0){this.notifyDeleted(deleted);this.notifyChanged()}this.fireEvent("clear",this)},this)},readProperties:function(doread){if(doread&&this.remoteData!=null){this.needsRefreshProperties=false;this.remoteData.getProperties(function(data){data.forEach(function(prop){if(!this.properties.hasOwnProperty(prop.group)){this.properties[prop.group]=new DataListPropertyGroup(this,prop.properties)}else{this.properties[prop.group].update(prop.properties)}this.fireEvent("property-group-changed",prop.group,this.properties[prop.group])},this)},this)}},commitProperties:function(){var v,p,changes=[];if(this.propertyupdating===false){for(p in this.properties){if(this.properties.hasOwnProperty(p)){v=this.properties[p];if(v.isChanged!==undefined&&v.isChanged()){changes.push({group:p,properties:v.getChanges()});v.clearChanges()}}}if(changes.length>0){this.remoteData.setProperties(changes)}}},refresh:function(callback){this.readProperties(this.needsRefreshProperties);if(this.needsRefresh){this.needsRefresh=false;if(this.remoteData!=null){this.remoteData.refresh(function(data){this.doRefresh(data);if(callback!==undefined){callback.call(this)}},this)}}else{this.fastRefresh=true}},internalDoRefresh:function(data){var i,ix,delMap={},delKeys=[],updates,key,newRec,oldRec,rec;if(data.reload){this.data=[];this.map={}}if(this.deleted.length>0){this.deleted.forEach(function(rec,i){delMap[rec.getKey()]=i},this)}if(data.updates!==undefined&&this.model!=null){updates=Array.isArray(data.updates)?data.updates:[data.updates];for(i=updates.length-1;i>=0;i--){newRec=updates[i];key=decodeRecordKey(this.dataEncoding,this.model,newRec);oldRec=this.map[key];if(oldRec!==undefined){oldRec.update(this.dataEncoding,newRec);this.notifyChanged(oldRec)}else{ix=delMap[key];if(ix!==undefined){this.deleted[ix].update(this.dataEncoding,newRec)}else{this.addRecord(this.model.newRecord(this.dataEncoding,newRec))}}}}if(data.deletes!==undefined){updates=Array.isArray(data.deletes)?data.deletes:[data.deletes];for(i=updates.length-1;i>=0;i--){key=updates[i];rec=this.map[key];if(rec!==undefined){this.delByRec(this.map[key],true)}else{ix=delMap[key];if(ix!==undefined){delKeys.push(ix)}}if(delKeys.length>0){delKeys.sort(function(a,b){return b-a});delKeys.forEach(function(ix){this.deleted.splice(ix,1)},this)}}}},doRefresh:function(data){if(data.success){this.beginUpdate();if(data.fields!=null){this.model=new DataListModel(this,{key:data.key,fields:data.fields})}try{this.internalDoRefresh(data)}finally{this.endUpdate(true);if(data.markers!=null){asArray(data.markers).forEach(function(m){this.fireEvent("change-marker",m)},this)}}}},getLocalChanges:function(){var result={changes:[]};result.changedRecords=this.data.filter(function(rec){var changes;if(rec.isChanged()){changes=rec.getChanges();if(changes!=null){result.changes.push(changes);return true}return false}else{return false}},this);result.deleted=this.deleted.map(function(rec){return rec.getKey()});return result},isChanged:function(){var log=this.getLocalChanges();return log.changes.length+log.deleted.length>0},commit:function(callback){var changeLog=this.getLocalChanges(),changed=false,called=false;this.deleted=[];if(changeLog.deleted.length>0){this.remoteData.remove(changeLog.deleted);changed=true}if(changeLog.changes.length>0){changed=true;called=true;this.remoteData.update(changeLog.changes,function(keys){keys=asArray(keys);changeLog.changedRecords.forEach(function(crec,i){if(i<keys.length){if(crec.getKey()===undefined){crec.setKey(keys[i]);this.map[keys[i]]=crec}}},this);if(callback!=null&&typeof callback==="function"){callback()}},this)}if(changed){this.fireEvent("commit",this);this.refresh()}if(!called&&changed&&callback!=null&&typeof callback==="function"){callback()}},revert:function(){var i;for(i=this.data.length-1;i>=0;i--){if(this.data[i].getKey()===undefined){this.data.splice(i,1)}else if(this.data[i].isChanged()){this.data[i].clearChanges()}}this.deleted.forEach(function(rec){if(rec.isChanged()){rec.clearChanges()}this.addRecord(rec)},this);this.deleted=[];this.fireEvent("revert",this);this.notifyChanged()}});return Constructor}();adrem.deepEqual=function(){var pSlice=Array.prototype.slice,objectKeys=Object.keys;function isArguments(object){return Object.prototype.toString.call(object)==="[object Arguments]"}function deepEqual(actual,expected,opts){opts=opts||{};if(actual===expected){return true}else if(actual instanceof Date&&expected instanceof Date){return actual.getTime()===expected.getTime()}else if(!actual||!expected||typeof actual!=="object"&&typeof expected!=="object"){return opts.strict?actual===expected:actual==expected}else{return objEquiv(actual,expected,opts)}}function isUndefinedOrNull(value){return value===null||value===undefined}function isBuffer(x){if(!x||typeof x!=="object"||typeof x.length!=="number"){return false}if(typeof x.copy!=="function"||typeof x.slice!=="function"){return false}return!(x.length>0&&typeof x[0]!=="number")}function objEquiv(a,b,opts){var i,key,ka,kb;if(isUndefinedOrNull(a)||isUndefinedOrNull(b)){return false}if(a.prototype!==b.prototype){return false}if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return deepEqual(a,b,opts)}if(isBuffer(a)){if(!isBuffer(b)){return false}if(a.length!==b.length){return false}for(i=0;i<a.length;i++){if(a[i]!==b[i]){return false}}return true}try{ka=objectKeys(a);kb=objectKeys(b)}catch(e){return false}if(ka.length!==kb.length){return false}ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!==kb[i]){return false}}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!deepEqual(a[key],b[key],opts)){return false}}return typeof a===typeof b}return deepEqual}();adrem.RemoteDataListStore=RemoteDataListStore;if(typeof module==="object"){module.exports=RemoteDataListStore}})(adrem)});